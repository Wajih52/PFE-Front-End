<!-- src/app/features/admin/pages/instances-list/instances-list.component.html -->

<div class="instances-container">
  <!-- En-tÃªte -->
  <div class="header">
    <div class="header-content">
      <h1>
        ğŸ”– Gestion des Instances
        <span *ngIf="nomProduitFilter" class="product-filter-badge">
          {{ nomProduitFilter }}
        </span>
      </h1>
      <div class="header-actions">
        <button *ngIf="idProduitFilter" class="btn btn-secondary" (click)="goToProducts()">
          â† Retour aux produits
        </button>
        <button class="btn btn-primary" (click)="goToCreate()">
          â• Nouvelle Instance
        </button>
      </div>
    </div>
  </div>

  <!-- Statistiques -->
  <div class="stats-cards">
    <div class="stat-card stat-total">
      <div class="stat-icon">ğŸ“¦</div>
      <div class="stat-info">
        <div class="stat-value">{{ stats.total }}</div>
        <div class="stat-label">Total instances</div>
      </div>
    </div>

    <div class="stat-card stat-disponible">
      <div class="stat-icon">âœ…</div>
      <div class="stat-info">
        <div class="stat-value">{{ stats.disponibles }}</div>
        <div class="stat-label">Disponibles</div>
      </div>
    </div>

    <div class="stat-card stat-reserve">
      <div class="stat-icon">ğŸ”’</div>
      <div class="stat-info">
        <div class="stat-value">{{ stats.reserves }}</div>
        <div class="stat-label">RÃ©servÃ©es</div>
      </div>
    </div>

    <div class="stat-card stat-maintenance">
      <div class="stat-icon">ğŸ”§</div>
      <div class="stat-info">
        <div class="stat-value">{{ stats.enMaintenance }}</div>
        <div class="stat-label">En maintenance</div>
      </div>
    </div>

    <div class="stat-card stat-hors-service">
      <div class="stat-icon">âŒ</div>
      <div class="stat-info">
        <div class="stat-value">{{ stats.horsService }}</div>
        <div class="stat-label">Hors service</div>
      </div>
    </div>
  </div>

  <!-- Message d'erreur -->
  <div *ngIf="errorMessage" class="alert alert-error">
    âš ï¸ {{ errorMessage }}
  </div>

  <!-- Filtres et recherche -->
  <div class="filters-section">
    <div class="search-bar">
      <input
        type="text"
        [(ngModel)]="searchTerm"
        (ngModelChange)="applyFilters()"
        placeholder="ğŸ” Rechercher par numÃ©ro de sÃ©rie, produit..."
        class="form-control"
      />
    </div>

    <div class="filters">
      <select
        [(ngModel)]="filterStatut"
        (ngModelChange)="applyFilters()"
        class="form-select"
      >
        <option value="">Tous les statuts</option>
        <option *ngFor="let statut of statutsList" [value]="statut">
          {{ StatutInstanceLabels[statut] }}
        </option>
      </select>

      <input
        type="text"
        [(ngModel)]="filterProduit"
        (ngModelChange)="applyFilters()"
        placeholder="Filtrer par produit..."
        class="form-control"
      />

      <button class="btn btn-secondary" (click)="resetFilters()">
        ğŸ”„ RÃ©initialiser
      </button>
    </div>
  </div>

  <!-- RÃ©sultats -->
  <div class="results-info">
    <p>
      <strong>{{ filteredInstances.length }}</strong> instance(s) trouvÃ©e(s)
      <span *ngIf="filteredInstances.length !== allInstances.length">
        sur {{ allInstances.length }} au total
      </span>
    </p>
    <div class="pagination-controls">
      <label>
        Afficher
        <select [(ngModel)]="itemsPerPage" (ngModelChange)="onItemsPerPageChange()" class="form-select-sm">
          <option [value]="10">10</option>
          <option [value]="25">25</option>
          <option [value]="50">50</option>
          <option [value]="100">100</option>
        </select>
        par page
      </label>
    </div>
  </div>

  <!-- Tableau des instances -->
  <div class="table-container">
    <div *ngIf="isLoading" class="loading">
      <div class="spinner"></div>
      <p>Chargement des instances...</p>
    </div>

    <table *ngIf="!isLoading" class="table">
      <thead>
      <tr>
        <th (click)="sortBy('numeroSerie')" class="sortable">
          NumÃ©ro de sÃ©rie
          <span *ngIf="sortColumn === 'numeroSerie'">
              {{ sortDirection === 'asc' ? 'â–²' : 'â–¼' }}
            </span>
        </th>
        <th (click)="sortBy('nomProduit')" class="sortable">
          Produit
          <span *ngIf="sortColumn === 'nomProduit'">
              {{ sortDirection === 'asc' ? 'â–²' : 'â–¼' }}
            </span>
        </th>
        <th (click)="sortBy('statut')" class="sortable">
          Statut
          <span *ngIf="sortColumn === 'statut'">
              {{ sortDirection === 'asc' ? 'â–²' : 'â–¼' }}
            </span>
        </th>
        <th>Commentaire</th>
        <th (click)="sortBy('dateAcquisition')" class="sortable">
          Date d'ajout
          <span *ngIf="sortColumn === 'dateAcquisition'">
              {{ sortDirection === 'asc' ? 'â–²' : 'â–¼' }}
            </span>
        </th>
        <th>Maintenance</th>
        <th>Actions</th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let instance of paginatedInstances" (click)="goToDetails(instance)" class="clickable-row">
        <td>
          <code class="numero-serie">{{ instance.numeroSerie }}</code>
        </td>
        <td>
          <strong>{{ instance.nomProduit }}</strong>
          <br>
        </td>
        <td>
            <span class="status-badge" [ngClass]="getStatutClass(instance.statut)">
              {{ StatutInstanceLabels[instance.statut] }}
            </span>
        </td>
        <td>
          <small *ngIf="instance.observation" class="text-muted">
            {{ instance.observation | slice:0:30 }}{{ instance.observation.length > 30 ? '...' : '' }}
          </small>
          <span *ngIf="!instance.observation" class="text-muted">-</span>
        </td>
        <td>
          {{ instance.dateAcquisition | date:'dd/MM/yyyy' }}
          <br>
          <small class="text-muted">par <strong>{{ instance.ajoutPar }}</strong></small>
        </td>
        <td>
          <div *ngIf="instance.statut === StatutInstance.EN_MAINTENANCE" class="maintenance-info">
            <span class="maintenance-badge">ğŸ”§ En maintenance</span>
            <small *ngIf="instance.dateDerniereMaintenance">
              Sortie Le : {{ instance.dateDerniereMaintenance | date:'dd/MM/yyyy' }}
            </small>
          </div>
          <span *ngIf="instance.statut !== StatutInstance.EN_MAINTENANCE" class="text-muted">-</span>
        </td>
        <td (click)="$event.stopPropagation()" class="actions-cell">
          <div class="action-buttons">
            <!-- Menu dÃ©roulant pour changement de statut -->
            <div class="dropdown">
              <button class="btn btn-sm btn-secondary dropdown-toggle">
                ğŸ”„ Statut
              </button>
              <div class="dropdown-menu">
                <button
                  *ngFor="let statut of statutsFiltresDropdown"
                  [disabled]="statut === instance.statut"
                  (click)="changerStatut(instance, statut)"
                  class="dropdown-item"
                >
                  {{ StatutInstanceLabels[statut] }}
                </button>
              </div>
            </div>

            <!-- Bouton maintenance -->
            <button
              *ngIf="instance.statut === StatutInstance.DISPONIBLE||instance.statut=== StatutInstance.HORS_SERVICE"
              class="btn btn-sm btn-warning"
              (click)="openMaintenanceModal(instance)"
              title="Envoyer en maintenance"
            >
              ğŸ”§
            </button>

            <!-- Bouton retour de maintenance -->
            <button
              *ngIf="instance.statut === StatutInstance.EN_MAINTENANCE"
              class="btn btn-sm btn-success"
              (click)="openRetourMaintenanceModal(instance)"
              title="Retour de maintenance"
            >
              âœ…
            </button>

            <!-- Bouton Ã©diter -->
            <button
              class="btn btn-sm btn-primary"
              (click)="goToEdit(instance)"
              title="Modifier"
            >
              âœï¸
            </button>

            <!-- Bouton supprimer -->
            <button
              class="btn btn-sm btn-danger"
              (click)="deleteInstance(instance)"
              title="Supprimer"
            >
              ğŸ—‘ï¸
            </button>
          </div>
        </td>
      </tr>

      <tr *ngIf="paginatedInstances.length === 0">
        <td colspan="7" class="no-data">
          <div class="empty-state">
            <div class="empty-icon">ğŸ“¦</div>
            <p>Aucune instance trouvÃ©e</p>
            <button class="btn btn-primary" (click)="goToCreate()">
              â• CrÃ©er la premiÃ¨re instance
            </button>
          </div>
        </td>
      </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div *ngIf="filteredInstances.length > 0" class="pagination">
    <button
      class="btn btn-sm btn-secondary"
      [disabled]="currentPage === 1"
      (click)="previousPage()"
    >
      â† PrÃ©cÃ©dent
    </button>

    <div class="page-numbers">
      <button
        *ngFor="let page of [].constructor(totalPages); let i = index"
        class="btn btn-sm"
        [ngClass]="{'btn-primary': currentPage === i + 1, 'btn-secondary': currentPage !== i + 1}"
        (click)="goToPage(i + 1)"
      >
        {{ i + 1 }}
      </button>
    </div>

    <button
      class="btn btn-sm btn-secondary"
      [disabled]="currentPage === totalPages"
      (click)="nextPage()"
    >
      Suivant â†’
    </button>
  </div>
</div>

<!-- Modal de maintenance -->
<div *ngIf="showMaintenanceModal" class="modal-overlay" (click)="closeMaintenanceModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>ğŸ”§ Envoyer en maintenance</h3>
      <button class="close-btn" (click)="closeMaintenanceModal()">âœ–</button>
    </div>
    <div class="modal-body">
      <p><strong>Instance :</strong> {{ instanceForMaintenance?.numeroSerie }}</p>
      <p><strong>Produit :</strong> {{ instanceForMaintenance?.nomProduit }}</p>

      <form #maintenanceForm="ngForm">
        <div class="form-group">
          <label for="motif">Motif de la maintenance *</label>
          <textarea
            id="motif"
            name="motif"
            #motif="ngModel"
            [(ngModel)]="maintenanceData.motif"
            required
            rows="3"
            class="form-control"
            placeholder="DÃ©crivez la raison de la maintenance..."
          ></textarea>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeMaintenanceModal()">
        Annuler
      </button>
      <button
        class="btn btn-warning"
        [disabled]="!maintenanceForm.valid"
        (click)="envoyerEnMaintenance(maintenanceData.motif)"
      >
        ğŸ”§ Envoyer en maintenance
      </button>
    </div>
  </div>
</div>

<!-- Modal de Retour De maintenance -->
<div *ngIf="showRetourMaintenanceModal" class="modal-overlay" (click)="closeRetourMaintenanceModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>ğŸ”§âœ… Retour De la maintenance</h3>
      <button class="close-btn" (click)="closeRetourMaintenanceModal()">âœ–</button>
    </div>
    <div class="modal-body">
      <p><strong>Instance :</strong> {{ instanceForRetourMaintenance?.numeroSerie }}</p>
      <p><strong>Produit :</strong> {{ instanceForRetourMaintenance?.nomProduit }}</p>

      <form #maintenanceForm="ngForm">
        <div class="form-group">
            <label for="dateProchain">Date de Prochain Maintenance prÃ©vue *</label>
            <input
              type="date"
              id="dateProchain"
              name="dateProchain"
              #dateProchain="ngModel"
              [(ngModel)]="retourMaintenanceData.dateProchaineMaintenance"
              required
              class="form-control"
            />
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeMaintenanceModal()">
        Annuler
      </button>
      <button
        class="btn btn-warning"
        [disabled]="!maintenanceForm.valid"
        (click)="retourDeMaintenance()"
      >
        âœ… Retour De la maintenance
      </button>
    </div>
  </div>
</div>

