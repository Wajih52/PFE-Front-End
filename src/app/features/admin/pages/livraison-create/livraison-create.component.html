<!-- src/app/features/admin/pages/livraison-create/livraison-create.component.html -->
<!-- üöö Template - Cr√©er une nouvelle livraison -->

<div class="container-fluid py-4">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <!-- En-t√™te -->
      <div class="d-flex align-items-center mb-4">
        <button class="btn btn-outline-secondary me-3" (click)="annuler()">
          <i class="bi bi-arrow-left"></i>
        </button>
        <div>
          <h2 class="mb-1">üöö Cr√©er une Nouvelle Livraison</h2>
          <p class="text-muted mb-0">Remplissez les informations et s√©lectionnez les produits √† livrer</p>
        </div>
      </div>

      <!-- Messages de feedback -->
      @if (successMessage()) {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          <i class="bi bi-check-circle me-2"></i>
          {{ successMessage() }}
        </div>
      }

      @if (errorMessage()) {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <i class="bi bi-exclamation-triangle me-2"></i>
          {{ errorMessage() }}
          <button type="button" class="btn-close" (click)="errorMessage.set('')"></button>
        </div>
      }

      <!-- Formulaire -->
      <form [formGroup]="livraisonForm" (ngSubmit)="onSubmit()">
        <!-- Informations de base -->
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
              <i class="bi bi-info-circle me-2"></i>
              Informations de Livraison
            </h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <!-- Titre -->
              <div class="col-md-6">
                <label for="titreLivraison" class="form-label">
                  Titre de la livraison <span class="text-danger">*</span>
                </label>
                <input
                  type="text"
                  class="form-control"
                  id="titreLivraison"
                  formControlName="titreLivraison"
                  [class.is-invalid]="submitted() && f['titreLivraison'].errors"
                  placeholder="Ex: Livraison Mariage Dupont">
                @if (submitted() && f['titreLivraison'].errors) {
                  <div class="invalid-feedback">
                    Le titre est obligatoire (minimum 3 caract√®res)
                  </div>
                }
              </div>

              <!-- Adresse -->
              <div class="col-md-6">
                <label for="adresseLivraison" class="form-label">
                  Adresse de livraison <span class="text-danger">*</span>
                </label>
                <input
                  type="text"
                  class="form-control"
                  id="adresseLivraison"
                  formControlName="adresseLivraison"
                  [class.is-invalid]="submitted() && f['adresseLivraison'].errors"
                  placeholder="123 Avenue de la R√©publique, Paris">
                @if (submitted() && f['adresseLivraison'].errors) {
                  <div class="invalid-feedback">
                    L'adresse est obligatoire (minimum 5 caract√®res)
                  </div>
                }
              </div>

              <!-- Date -->
              <div class="col-md-6">
                <label for="dateLivraison" class="form-label">
                  Date de livraison <span class="text-danger">*</span>
                </label>
                <input
                  type="date"
                  class="form-control"
                  id="dateLivraison"
                  formControlName="dateLivraison"
                  [class.is-invalid]="submitted() && f['dateLivraison'].errors">
                @if (submitted() && f['dateLivraison'].errors) {
                  <div class="invalid-feedback">
                    La date est obligatoire
                  </div>
                }
              </div>

              <!-- Heure -->
              <div class="col-md-6">
                <label for="heureLivraison" class="form-label">
                  Heure de livraison <span class="text-danger">*</span>
                </label>
                <input
                  type="time"
                  class="form-control"
                  id="heureLivraison"
                  formControlName="heureLivraison"
                  [class.is-invalid]="submitted() && f['heureLivraison'].errors">
                @if (submitted() && f['heureLivraison'].errors) {
                  <div class="invalid-feedback">
                    L'heure est obligatoire
                  </div>
                }
              </div>

              <!-- Observations -->
              <div class="col-12">
                <label for="observations" class="form-label">
                  Observations / Notes
                </label>
                <textarea
                  class="form-control"
                  id="observations"
                  formControlName="observations"
                  rows="3"
                  placeholder="Notes ou instructions particuli√®res..."></textarea>
              </div>
            </div>
          </div>
        </div>

        <!-- S√©lection des lignes de r√©servation -->
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0">
                <i class="bi bi-box-seam me-2"></i>
                Produits √† Livrer
                <span class="badge bg-light text-dark ms-2">
                  {{ getNombreLignesSelectionnees() }} / {{ getNombreLignesDisponibles() }}
                </span>
              </h5>
              <div class="btn-group btn-group-sm">
                <button
                  type="button"
                  class="btn btn-light"
                  (click)="selectionnerToutesLignes()">
                  Tout s√©lectionner
                </button>
                <button
                  type="button"
                  class="btn btn-light"
                  (click)="deselectionnerToutesLignes()">
                  Tout d√©s√©lectionner
                </button>
              </div>
            </div>
          </div>
          <div class="card-body">
            <!-- Filtres -->
            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <label for="filtreReservation" class="form-label">Filtrer par r√©servation :</label>
                <input
                  type="text"
                  class="form-control"
                  id="filtreReservation"
                  [(ngModel)]="filtreReservation"
                  [ngModelOptions]="{standalone: true}"
                  placeholder="R√©f√©rence r√©servation...">
              </div>
              <div class="col-md-6">
                <label for="filtreProduit" class="form-label">Filtrer par produit :</label>
                <input
                  type="text"
                  class="form-control"
                  id="filtreProduit"
                  [(ngModel)]="filtreProduit"
                  [ngModelOptions]="{standalone: true}"
                  placeholder="Nom du produit...">
              </div>
            </div>

            <!-- Loading -->
            @if (isLoading()) {
              <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-3 text-muted">Chargement des lignes disponibles...</p>
              </div>
            }

            <!-- Aucune ligne disponible -->
            @if (!isLoading() && lignesDisponibles().length === 0) {
              <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                Aucune ligne de r√©servation disponible pour livraison.
              </div>
            }

            <!-- Table des lignes -->
            @if (!isLoading() && lignesDisponibles().length > 0) {
              <div class="table-responsive">
                <table class="table table-hover align-middle">
                  <thead class="table-light">
                  <tr>
                    <th width="50">
                      <input
                        type="checkbox"
                        class="form-check-input"
                        [checked]="getNombreLignesSelectionnees() === getNombreLignesDisponibles() && getNombreLignesDisponibles() > 0"
                        (change)="getNombreLignesSelectionnees() === getNombreLignesDisponibles() ? deselectionnerToutesLignes() : selectionnerToutesLignes()">
                    </th>
                    <th>R√©servation</th>
                    <th>Produit</th>
                    <th>Quantit√©</th>
                    <th>Date d√©but</th>
                    <th>Date fin</th>
                  </tr>
                  </thead>
                  <tbody>
                    @for (ligne of getLignesFiltrees(); track ligne.idLigneReservation) {
                      <tr
                        (click)="toggleLigneSelection(ligne.idLigneReservation)"
                        [class.table-primary]="isLigneSelectionnee(ligne.idLigneReservation)"
                        style="cursor: pointer;">
                        <td>
                          <input
                            type="checkbox"
                            class="form-check-input"
                            [checked]="isLigneSelectionnee(ligne.idLigneReservation)"
                            (click)="$event.stopPropagation()">
                        </td>
                        <td>
                          <small class="text-muted">{{ ligne.referenceReservation }}</small>
                        </td>
                        <td>
                          <strong>{{ ligne.nomProduit }}</strong>
                        </td>
                        <td>
                          <span class="badge bg-secondary">{{ ligne.quantite }}</span>
                        </td>
                        <td>{{ ligne.dateDebut }}</td>
                        <td>{{ ligne.dateFin }}</td>
                      </tr>
                    } @empty {
                      <tr>
                        <td colspan="6" class="text-center text-muted">
                          Aucune ligne ne correspond aux filtres
                        </td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>

              <!-- Info s√©lection -->
              @if (getNombreLignesSelectionnees() > 0) {
                <div class="alert alert-info mb-0">
                  <i class="bi bi-check-circle me-2"></i>
                  <strong>{{ getNombreLignesSelectionnees() }}</strong> ligne(s) s√©lectionn√©e(s)
                </div>
              }
            }
          </div>
        </div>

        <!-- Boutons d'action -->
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <button
                type="button"
                class="btn btn-secondary"
                (click)="annuler()"
                [disabled]="isSaving()">
                <i class="bi bi-x-circle me-2"></i>
                Annuler
              </button>

              <button
                type="submit"
                class="btn btn-primary btn-lg"
                [disabled]="isSaving() || getNombreLignesSelectionnees() === 0">
                @if (isSaving()) {
                  <span class="spinner-border spinner-border-sm me-2"></span>
                  Cr√©ation en cours...
                } @else {
                  <i class="bi bi-check-circle me-2"></i>
                  Cr√©er la Livraison
                }
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
