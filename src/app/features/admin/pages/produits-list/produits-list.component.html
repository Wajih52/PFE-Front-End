<!-- src/app/features/admin/pages/produits-list/produits-list.component.html (VERSION CORRIG√âE) -->
<div class="produits-container">
  <!-- En-t√™te -->
  <div class="page-header">
    <div class="header-content">
      <h1>üì¶ Gestion des Produits</h1>
      <p class="subtitle">Gestion des produits et du stock</p>
    </div>
    <button class="btn btn-primary" (click)="goToCreate()">
      <span>‚ûï</span> Nouveau produit
    </button>
  </div>

  <!-- Messages -->
  <div *ngIf="successMessage" class="alert alert-success">
    ‚úÖ {{ successMessage }}
  </div>
  <div *ngIf="errorMessage" class="alert alert-danger">
    ‚ùå {{ errorMessage }}
  </div>

  <!-- Statistiques -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon">üì¶</div>
      <div class="stat-content">
        <span class="stat-value">{{ stats.total }}</span>
        <span class="stat-label">Total produits</span>
      </div>
    </div>

    <div class="stat-card stat-success">
      <div class="stat-icon">‚úÖ</div>
      <div class="stat-content">
        <span class="stat-value">{{ stats.disponibles }}</span>
        <span class="stat-label">Disponibles</span>
      </div>
    </div>

    <div class="stat-card stat-warning">
      <div class="stat-icon">‚ö†Ô∏è</div>
      <div class="stat-content">
        <span class="stat-value">{{ stats.critique }}</span>
        <span class="stat-label">Stock critique</span>
      </div>
    </div>

    <div class="stat-card stat-danger">
      <div class="stat-icon">‚ùå</div>
      <div class="stat-content">
        <span class="stat-value">{{ stats.rupture }}</span>
        <span class="stat-label">En rupture</span>
      </div>
    </div>
  </div>

  <!-- Filtres et recherche -->
  <div class="filters-section">
    <div class="search-box">
      <input
        type="text"
        [(ngModel)]="searchTerm"
        (ngModelChange)="applyFilters()"
        placeholder="üîç Rechercher par nom, code ou description..."
        class="form-control"
      />
    </div>

    <div class="filters-row">
      <select
        [(ngModel)]="filterCategorie"
        (ngModelChange)="applyFilters()"
        class="form-select"
      >
        <option value="">Toutes les cat√©gories</option>
        <option *ngFor="let cat of categoriesList" [value]="cat">
          {{ CategorieLabels[cat] }}
        </option>
      </select>

      <select
        [(ngModel)]="filterType"
        (ngModelChange)="applyFilters()"
        class="form-select"
      >
        <option value="">Tous les types</option>
        <option *ngFor="let type of typesList" [value]="type">
          {{ TypeProduitLabels[type] }}
        </option>
      </select>

      <select
        [(ngModel)]="filterStatut"
        (ngModelChange)="applyFilters()"
        class="form-select"
      >
        <option value="">Tous les statuts</option>
        <option value="disponible">Disponibles</option>
        <option value="critique">Stock critique</option>
        <option value="rupture">En rupture</option>
      </select>

      <button class="btn btn-secondary" (click)="resetFilters()">
        üîÑ R√©initialiser
      </button>
    </div>
<br>
    <!-- Zone filtre date -->
    <div class="date-filter-zone">
      <div class="date-filter-header">
        <h3>üìÖ Filtrer par p√©riode de disponibilit√©</h3>
        <p class="subtitle">Voir la disponibilit√© r√©elle des produits sur une p√©riode donn√©e</p>
      </div>

      <div class="date-filter-inputs">
        <div class="input-group">
          <label for="dateDebut">
            <i class="fas fa-calendar-day"></i>
            Date de d√©but
          </label>
          <input
            type="date"
            id="dateDebut"
            [(ngModel)]="filterDateDebut"
            class="date-input"
            [min]="getMinDate()"
          />
        </div>

        <div class="input-group">
          <label for="dateFin">
            <i class="fas fa-calendar-day"></i>
            Date de fin
          </label>
          <input
            type="date"
            id="dateFin"
            [(ngModel)]="filterDateFin"
            class="date-input"
            [min]="filterDateDebut || getMinDate()"
          />
        </div>

        <div class="action-buttons-group">
          <button
            class="btn btn-primary btn-apply"
            (click)="applyDateFilter()"
            [disabled]="!filterDateDebut || !filterDateFin || isLoadingDisponibilite"
          >
            <i class="fas fa-search"></i>
            {{ isLoadingDisponibilite ? 'Chargement...' : 'Appliquer' }}
          </button>

          <button
            class="btn btn-secondary btn-reset"
            (click)="resetDateFilter()"
            *ngIf="produitsDisponibilite.length > 0"
          >
            <i class="fas fa-times"></i>
            R√©initialiser
          </button>
        </div>
      </div>

      <div *ngIf="filterDateDebut && filterDateFin && produitsDisponibilite.length > 0"
           class="active-filter-badge">
        <i class="fas fa-check-circle"></i>
        Filtre actif : du {{ formatDate(filterDateDebut) }} au {{ formatDate(filterDateFin) }}
      </div>
    </div>
  </div>

  <!-- Tableau des produits -->
  <div class="table-container">
    <div *ngIf="isLoading" class="loading">
      <div class="spinner"></div>
      <p>Chargement des produits...</p>
    </div>

    <table *ngIf="!isLoading" class="table">
      <thead>
      <tr>
        <th (click)="sortBy('codeProduit')" class="sortable">
          Code
          <span *ngIf="sortColumn === 'codeProduit'">
              {{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}
            </span>
        </th>
        <th>Image</th>
        <th (click)="sortBy('nomProduit')" class="sortable">
          Nom
          <span *ngIf="sortColumn === 'nomProduit'">
              {{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}
            </span>
        </th>
        <th>Cat√©gorie</th>
        <th>Type</th>
        <th (click)="sortBy('prixUnitaire')" class="sortable">
          Prix
          <span *ngIf="sortColumn === 'prixUnitaire'">
              {{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}
            </span>
        </th>
        <th (click)="sortBy('quantiteDisponible')" class="sortable">
          Stock
          <span *ngIf="sortColumn === 'quantiteDisponible'">
              {{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}
            </span>
          <span *ngIf="filterDateDebut && filterDateFin" class="filter-info">
             ({{ formatDate(filterDateDebut) }} - {{ formatDate(filterDateFin) }})
          </span>
        </th>
        <th>Statut</th>
        <th>Actions</th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let produit of paginatedProduits">
        <td>
          <code>{{ produit.codeProduit }}</code>
        </td>
        <td>
          <div class="product-image">
            <img
              *ngIf="produit.imageProduit"
              [src]="'http://localhost:8080' + produit.imageProduit"
              [alt]="produit.nomProduit"
            />
            <div *ngIf="!produit.imageProduit" class="no-image">üì¶</div>
          </div>
        </td>
        <td>
          <strong>{{ produit.nomProduit }}</strong>
          <br>
          <small *ngIf="produit.descriptionProduit" class="text-muted">
            {{ produit.descriptionProduit | slice:0:20 }}{{ produit.descriptionProduit.length > 20 ? '...' : '' }}
          </small>
        </td>
        <td>
            <span class="badge badge-secondary">
              {{ CategorieLabels[produit.categorieProduit] }}
            </span>
        </td>
        <td>
            <span class="badge" [class.badge-info]="produit.typeProduit === TypeProduit.AVEC_REFERENCE"
                  [class.badge-info-2]="produit.typeProduit === TypeProduit.EN_QUANTITE">
              {{ TypeProduitLabels[produit.typeProduit] }}
            </span>
        </td>
        <td>{{ produit.prixUnitaire | number:'1.2-2' }} TND</td>
        <td>
          <div class="stock-info" *ngIf="produitsDisponibilite.length === 0; else withDateFilter">
            <!-- Affichage normal sans filtre -->
            <span [ngClass]="getStockStatusClass(produit)">
               {{ produit.quantiteDisponible }}
            </span>
          </div>

          <ng-template #withDateFilter>
            <!-- Affichage avec filtre de date actif -->
            <div class="stock-with-period">
              <div class="stock-disponible">
                <span class="label">Disponible:</span>
                <span class="value disponible">
                   {{ getDisponibilitePourProduit(produit.idProduit)?.quantiteDisponible || 0 }}
               </span>
              </div>
              <div class="stock-reservee">
                <span class="label">R√©serv√©:</span>
                <span class="value reservee">
                  {{ getDisponibilitePourProduit(produit.idProduit)?.quantiteReservee || 0 }}
                </span>
              </div>
              <div class="stock-total">
                <span class="label">Total:</span>
                <span class="value total">
                      {{ getDisponibilitePourProduit(produit.idProduit)?.quantiteTotale || 0 }}
                </span>
              </div>
            </div>
          </ng-template>
          <div *ngIf="produit.maintenanceRequise" class="maintenance-badge">
            üîß Maintenance
          </div>
        </td>
        <td>
            <span
              class="badge stock-info"
              [class]="getStockStatusClass(produit)"
            >
              {{ getStockStatusLabel(produit) }}
            </span>
        </td>
        <td>
          <div class="action-buttons">
            <button
              class="btn btn-sm btn-info"
              (click)="showDetails(produit)"
              title="D√©tails"
            >
              üëÅÔ∏è
            </button>
            <button
              class="btn btn-sm btn-primary"
              (click)="goToEdit(produit.idProduit)"
              title="Modifier"
            >
              ‚úèÔ∏è
            </button>
            <button
              *ngIf="produit.typeProduit === TypeProduit.AVEC_REFERENCE"
              class="btn btn-sm btn-secondary"
              (click)="goToInstances(produit)"
              title="G√©rer les instances"
            >
              üî¢
            </button>
            <button
              class="btn btn-sm btn-primary"
              (click)="openAjustementModal(produit)"
              title="Ajuster le stock"
              *ngIf="produit.typeProduit === 'EN_QUANTITE'"
            >
              üìâ
            </button>
            <button
              class="btn btn-sm btn-normal"
              (click)="goToMouvements(produit.idProduit)"
              title="Historique"
            >
              üìä
            </button>
            <!-- Boutons selon l'√©tat du produit -->
            <ng-container *ngIf="produit.quantiteDisponible > 0">
              <!-- Produit actif -->
              <button
                class="btn btn-sm btn-warning"
                (click)="desactiverProduit(produit)"
                title="D√©sactiver"
              >
                ‚è∏Ô∏è
              </button>
            </ng-container>

            <ng-container *ngIf="produit.quantiteDisponible === 0">
              <!-- Produit d√©sactiv√© -->
              <button
                class="btn btn-sm btn-success"
                (click)="openReactivationModal(produit)"
                title="R√©activer"
              >
                ‚ñ∂Ô∏è
              </button>
            </ng-container>
            <button
              class="btn btn-sm btn-danger"
              (click)="deleteProduit(produit)"
              title="Supprimer"
            >
              üóëÔ∏è
            </button>
          </div>
        </td>
      </tr>

      <tr *ngIf="filteredProduits.length === 0">
        <td colspan="9" class="text-center text-muted">
          <p>Aucun produit trouv√©</p>
        </td>
      </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div *ngIf="totalPages > 1" class="pagination">
    <button
      class="btn btn-sm"
      [disabled]="currentPage === 1"
      (click)="goToPage(currentPage - 1)"
    >
      ‚Üê Pr√©c√©dent
    </button>

    <span class="page-info">
      Page {{ currentPage }} / {{ totalPages }}
      ({{ filteredProduits.length }} produits)
    </span>

    <button
      class="btn btn-sm"
      [disabled]="currentPage === totalPages"
      (click)="goToPage(currentPage + 1)"
    >
      Suivant ‚Üí
    </button>
  </div>
</div>

<!-- Modal d√©tails produit -->
<div *ngIf="showDetailsModal && selectedProduit" class="modal-overlay" (click)="closeDetailsModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>üì¶ D√©tails du produit</h2>
      <button class="btn-close" (click)="closeDetailsModal()">‚úï</button>
    </div>

    <div class="modal-body">
      <div class="product-details">
        <div *ngIf="selectedProduit.imageProduit" class="product-image-large">
          <img [src]="'http://localhost:8080' + selectedProduit.imageProduit" [alt]="selectedProduit.nomProduit"/>
        </div>

        <div class="details-grid">
          <div class="detail-item">
            <strong>Code:</strong>
            <span>{{ selectedProduit.codeProduit }}</span>
          </div>

          <div class="detail-item">
            <strong>Nom:</strong>
            <span>{{ selectedProduit.nomProduit }}</span>
          </div>

          <div class="detail-item">
            <strong>Cat√©gorie:</strong>
            <span>{{ CategorieLabels[selectedProduit.categorieProduit] }}</span>
          </div>

          <div class="detail-item">
            <strong>Type:</strong>
            <span>{{ TypeProduitLabels[selectedProduit.typeProduit] }}</span>
          </div>

          <div class="detail-item">
            <strong>Prix unitaire:</strong>
            <span>{{ selectedProduit.prixUnitaire | number:'1.2-2' }} TND</span>
          </div>

          <div class="detail-item">
            <strong>Quantit√© initiale:</strong>
            <span>{{ selectedProduit.quantiteInitial }}</span>
          </div>

          <div class="detail-item">
            <strong>Stock disponible:</strong>
            <span [class]="getStockStatusClass(selectedProduit)">
              {{ selectedProduit.quantiteDisponible }} unit√©s
            </span>
          </div>

          <div class="detail-item">
            <strong>Seuil critique:</strong>
            <span>{{ selectedProduit.seuilCritique }}</span>
          </div>

          <div class="detail-item">
            <strong>Maintenance requise:</strong>
            <span>{{ selectedProduit.maintenanceRequise ? 'Oui' : 'Non' }}</span>
          </div>

          <div class="detail-item">
            <strong>En stock:</strong>
            <span [class.text-success]="selectedProduit.enStock" [class.text-danger]="!selectedProduit.enStock">
             {{ selectedProduit.quantiteDisponible > 0 ? 'Oui' : 'Non' }}
            </span>
          </div>

          <div *ngIf="selectedProduit.descriptionProduit" class="detail-item full-width">
            <strong>Description:</strong>
            <p>{{ selectedProduit.descriptionProduit }}</p>
          </div>

          <div class="detail-item">
            <strong>Cr√©√© le:</strong>
            <span>{{ selectedProduit.dateCreation | date:'dd/MM/yyyy HH:mm' }}</span>
          </div>

          <div class="detail-item">
            <strong>Modifi√© le:</strong>
            <span>{{ selectedProduit.dateDerniereModification | date:'dd/MM/yyyy HH:mm' }}</span>
          </div>

          <div *ngIf="selectedProduit.nombreReservations" class="detail-item">
            <strong>Nombre de r√©servations:</strong>
            <span>{{ selectedProduit.nombreReservations }}</span>
          </div>

          <div *ngIf="selectedProduit.moyenneNotes" class="detail-item">
            <strong>Note moyenne:</strong>
            <span>{{ selectedProduit.moyenneNotes | number:'1.1-1' }} / 5 ‚≠ê ({{ selectedProduit.nombreAvis }}
              avis)</span>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-primary" (click)="goToEdit(selectedProduit.idProduit)">
        ‚úèÔ∏è Modifier
      </button>
      <button
        *ngIf="selectedProduit.typeProduit === TypeProduit.AVEC_REFERENCE"
        class="btn btn-secondary"
        (click)="goToInstances(selectedProduit)"
      >
        üî¢ G√©rer les instances
      </button>
      <button class="btn btn-warning" (click)="goToMouvements(selectedProduit.idProduit)">
        üìä Historique
      </button>
      <button class="btn btn-secondary" (click)="closeDetailsModal()">
        Fermer
      </button>
    </div>
  </div>
</div>

<!-- Modal ajustement stock -->
<div *ngIf="showAjustementModal && produitAjustement" class="modal-overlay" (click)="closeAjustementModal()">
  <div class="modal-content modal-ajustement" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>üìä Ajuster le stock</h2>
      <button class="btn-close" (click)="closeAjustementModal()">‚úï</button>
    </div>

    <div class="modal-body">
      <div class="info-produit">
        <h3>{{ produitAjustement.nomProduit }}</h3>
        <p><strong>Code:</strong> {{ produitAjustement.codeProduit }}</p>
        <p><strong>Stock actuel:</strong> <span class="current-stock">{{ produitAjustement.quantiteDisponible }}</span>
        </p>
      </div>

      <div class="form-group">
        <label for="nouvelleQuantite" class="required">Nouvelle quantit√©</label>
        <input
          type="number"
          id="nouvelleQuantite"
          [(ngModel)]="nouvelleQuantite"
          class="form-control"
          min="0"
          placeholder="0"
        />
        <div class="stock-diff" [class.positive]="nouvelleQuantite - produitAjustement.quantiteDisponible > 0"
             [class.negative]="nouvelleQuantite - produitAjustement.quantiteDisponible < 0">
          Diff√©rence: {{ nouvelleQuantite - produitAjustement.quantiteDisponible >= 0 ? '+' : '' }}{{ nouvelleQuantite - produitAjustement.quantiteDisponible }}
        </div>
      </div>

      <div class="form-group">
        <label for="motifAjustement" class="required">Motif de l'ajustement</label>
        <textarea
          id="motifAjustement"
          [(ngModel)]="motifAjustement"
          class="form-control"
          rows="3"
          placeholder="Ex: Inventaire, correction erreur de saisie, casse, vol..."
        ></textarea>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeAjustementModal()">
        Annuler
      </button>
      <button
        class="btn btn-primary"
        (click)="submitAjustementStock()"
        [disabled]="!motifAjustement.trim()"
      >
        ‚úÖ Ajuster le stock
      </button>
    </div>
  </div>
</div>

<!-- Modal r√©activation produit  -->
<div *ngIf="showReactivationModal && produitReactivation"
     class="modal-overlay"
     (click)="closeReactivationModal()">
  <div class="modal-content modal-reactivation" (click)="$event.stopPropagation()">

    <!-- En-t√™te -->
    <div class="modal-header">
      <div class="header-content">
        <div class="icon-wrapper">
          <i class="fas fa-redo-alt"></i>
        </div>
        <div class="header-text">
          <h2>R√©activer le produit</h2>
          <p>Remettre ce produit en service</p>
        </div>
      </div>
      <button class="btn-close" (click)="closeReactivationModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <!-- Corps du modal -->
    <div class="modal-body">

      <!-- Informations produit -->
      <div class="info-produit-card">
        <div class="info-row">
          <div class="info-item">
            <span class="info-label">Nom</span>
            <span class="info-value primary">{{ produitReactivation.nomProduit }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Code</span>
            <span class="info-value code">{{ produitReactivation.codeProduit }}</span>
          </div>
        </div>

        <div class="info-row">
          <div class="info-item">
            <span class="info-label">Cat√©gorie</span>
            <span class="info-value">
              {{ CategorieLabels[produitReactivation.categorieProduit] }}
            </span>
          </div>
          <div class="info-item">
            <span class="info-label">Type</span>
            <span class="info-value badge"
                  [class.badge-quantite]="produitReactivation.typeProduit === TypeProduit.EN_QUANTITE"
                  [class.badge-reference]="produitReactivation.typeProduit === TypeProduit.AVEC_REFERENCE">
              {{ TypeProduitLabels[produitReactivation.typeProduit] }}
            </span>
          </div>
        </div>
      </div>

      <!-- Formulaire selon le type -->
      <div *ngIf="produitReactivation.typeProduit === TypeProduit.EN_QUANTITE"
           class="form-section">
        <div class="form-group">
          <label for="quantiteReactivation" class="required">
            <i class="fas fa-boxes"></i>
            Quantit√© initiale de stock
          </label>
          <input
            type="number"
            id="quantiteReactivation"
            [(ngModel)]="quantiteReactivation"
            class="form-control"
            min="0"
            step="1"
            placeholder="Ex: 100"
            [class.error]="quantiteReactivation < 0"
          />
          <div class="help-text">
            <i class="fas fa-info-circle"></i>
            Cette quantit√© sera le stock de d√©part apr√®s r√©activation
          </div>
          <div *ngIf="quantiteReactivation < 0" class="error-message">
            <i class="fas fa-exclamation-triangle"></i>
            La quantit√© ne peut pas √™tre n√©gative
          </div>
        </div>
      </div>

      <!-- Message pour produits avec r√©f√©rence -->
      <div *ngIf="produitReactivation.typeProduit === TypeProduit.AVEC_REFERENCE"
           class="info-message">
        <div class="icon-container">
          <i class="fas fa-info-circle"></i>
        </div>
        <div class="message-content">
          <p class="message-title">Produit avec r√©f√©rence</p>
          <p class="message-text">
            Apr√®s r√©activation, vous devrez cr√©er des instances individuelles
            (avec num√©ros de s√©rie) pour ce produit.
          </p>
        </div>
      </div>

      <!-- Avertissement -->
      <div class="warning-message">
        <div class="icon-container">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="message-content">
          <p class="message-text">
            <strong>Attention:</strong> Le produit redeviendra visible et disponible
            pour les clients imm√©diatement apr√®s r√©activation.
          </p>
        </div>
      </div>

    </div>

    <!-- Pied du modal -->
    <div class="modal-footer">
      <button class="btn btn-cancel" (click)="closeReactivationModal()">
        <i class="fas fa-times"></i>
        Annuler
      </button>
      <button
        class="btn btn-success"
        (click)="reactiverProduit()"
        [disabled]="produitReactivation.typeProduit === TypeProduit.EN_QUANTITE &&
                    (quantiteReactivation === null || quantiteReactivation === undefined || quantiteReactivation < 0)"
      >
        <i class="fas fa-check"></i>
        R√©activer le produit
      </button>
    </div>

  </div>
</div>
