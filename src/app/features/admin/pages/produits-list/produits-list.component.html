<!-- src/app/features/admin/pages/produits-list/produits-list.component.html (VERSION CORRIG√âE) -->
<app-menu-navigation></app-menu-navigation>
<div class="produits-container">
  <!-- En-t√™te -->
  <div class="page-header">
    <div class="header-content">
      <h1>üì¶ Gestion des Produits</h1>
      <p class="subtitle">Gestion des produits et du stock</p>
    </div>
    <button class="btn btn-primary" (click)="goToCreate()">
      <span>‚ûï</span> Nouveau produit
    </button>
  </div>

  <!-- Messages -->
  <div *ngIf="successMessage" class="alert alert-success">
    ‚úÖ {{ successMessage }}
  </div>
  <div *ngIf="errorMessage" class="alert alert-danger">
    ‚ùå {{ errorMessage }}
  </div>

  <!-- Statistiques -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon">üì¶</div>
      <div class="stat-content">
        <span class="stat-value">{{ stats.total }}</span>
        <span class="stat-label">Total produits</span>
      </div>
    </div>

    <div class="stat-card stat-success">
      <div class="stat-icon">‚úÖ</div>
      <div class="stat-content">
        <span class="stat-value">{{ stats.disponibles }}</span>
        <span class="stat-label">Disponibles</span>
      </div>
    </div>

    <div class="stat-card stat-warning">
      <div class="stat-icon">‚ö†Ô∏è</div>
      <div class="stat-content">
        <span class="stat-value">{{ stats.critique }}</span>
        <span class="stat-label">Stock critique</span>
      </div>
    </div>

    <div class="stat-card stat-danger">
      <div class="stat-icon">‚ùå</div>
      <div class="stat-content">
        <span class="stat-value">{{ stats.rupture }}</span>
        <span class="stat-label">En rupture</span>
      </div>
    </div>
  </div>

  <!-- Filtres et recherche -->
  <div class="filters-section">
    <div class="search-box">
      <input
        type="text"
        [(ngModel)]="searchTerm"
        (ngModelChange)="applyFilters()"
        placeholder="üîç Rechercher par nom, code ou description..."
        class="form-control"
      />
    </div>

    <div class="filters-row">
      <select
        [(ngModel)]="filterCategorie"
        (ngModelChange)="applyFilters()"
        class="form-select"
      >
        <option value="">Toutes les cat√©gories</option>
        <option *ngFor="let cat of categoriesList" [value]="cat">
          {{ CategorieLabels[cat] }}
        </option>
      </select>

      <select
        [(ngModel)]="filterType"
        (ngModelChange)="applyFilters()"
        class="form-select"
      >
        <option value="">Tous les types</option>
        <option *ngFor="let type of typesList" [value]="type">
          {{ TypeProduitLabels[type] }}
        </option>
      </select>

      <select
        [(ngModel)]="filterStatut"
        (ngModelChange)="applyFilters()"
        class="form-select"
      >
        <option value="">Tous les statuts</option>
        <option value="disponible">Disponibles</option>
        <option value="critique">Stock critique</option>
        <option value="rupture">En rupture</option>
      </select>

      <button class="btn btn-secondary" (click)="resetFilters()">
        üîÑ R√©initialiser
      </button>
    </div>
  </div>

  <!-- Tableau des produits -->
  <div class="table-container">
    <div *ngIf="isLoading" class="loading">
      <div class="spinner"></div>
      <p>Chargement des produits...</p>
    </div>

    <table *ngIf="!isLoading" class="table">
      <thead>
      <tr>
        <th (click)="sortBy('codeProduit')" class="sortable">
          Code
          <span *ngIf="sortColumn === 'codeProduit'">
              {{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}
            </span>
        </th>
        <th>Image</th>
        <th (click)="sortBy('nomProduit')" class="sortable">
          Nom
          <span *ngIf="sortColumn === 'nomProduit'">
              {{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}
            </span>
        </th>
        <th>Cat√©gorie</th>
        <th>Type</th>
        <th (click)="sortBy('prixUnitaire')" class="sortable">
          Prix
          <span *ngIf="sortColumn === 'prixUnitaire'">
              {{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}
            </span>
        </th>
        <th (click)="sortBy('quantiteDisponible')" class="sortable">
          Stock
          <span *ngIf="sortColumn === 'quantiteDisponible'">
              {{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}
            </span>
        </th>
        <th>Statut</th>
        <th>Actions</th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let produit of paginatedProduits">
        <td>
          <code>{{ produit.codeProduit }}</code>
        </td>
        <td>
          <div class="product-image">
            <img
              *ngIf="produit.imageProduit"
              [src]="'http://localhost:8080' + produit.imageProduit"
              [alt]="produit.nomProduit"
            />
            <div *ngIf="!produit.imageProduit" class="no-image">üì¶</div>
          </div>
        </td>
        <td>
          <strong>{{ produit.nomProduit }}</strong>
          <br>
          <small *ngIf="produit.descriptionProduit" class="text-muted">
            {{ produit.descriptionProduit | slice:0:20 }}{{ produit.descriptionProduit.length > 20 ? '...' : '' }}
          </small>
        </td>
        <td>
            <span class="badge badge-secondary">
              {{ CategorieLabels[produit.categorieProduit] }}
            </span>
        </td>
        <td>
            <span class="badge" [class.badge-info]="produit.typeProduit === TypeProduit.AVEC_REFERENCE"
                  [class.badge-info-2]="produit.typeProduit === TypeProduit.EN_QUANTITE">
              {{ TypeProduitLabels[produit.typeProduit] }}
            </span>
        </td>
        <td>{{ produit.prixUnitaire | number:'1.2-2' }} TND</td>
        <td>
            <span class="stock-info" [class]="getStockStatusClass(produit)">
              {{ produit.quantiteDisponible }}
            </span>
          <div *ngIf="produit.maintenanceRequise" class="maintenance-badge">
            üîß Maintenance
          </div>
        </td>
        <td>
            <span
              class="badge"
              [class]="getStockStatusClass(produit)"
            >
              {{ getStockStatusLabel(produit) }}
            </span>
        </td>
        <td>
          <div class="action-buttons">
            <button
              class="btn btn-sm btn-info"
              (click)="showDetails(produit)"
              title="D√©tails"
            >
              üëÅÔ∏è
            </button>
            <button
              class="btn btn-sm btn-primary"
              (click)="goToEdit(produit.idProduit)"
              title="Modifier"
            >
              ‚úèÔ∏è
            </button>
            <button
              *ngIf="produit.typeProduit === TypeProduit.AVEC_REFERENCE"
              class="btn btn-sm btn-secondary"
              (click)="goToInstances(produit)"
              title="G√©rer les instances"
            >
              üî¢
            </button>
            <button
              class="btn btn-sm btn-warning"
              (click)="goToMouvements(produit.idProduit)"
              title="Historique"
            >
              üìä
            </button>
            <button
              class="btn btn-sm btn-danger"
              (click)="deleteProduit(produit)"
              title="Supprimer"
            >
              üóëÔ∏è
            </button>
          </div>
        </td>
      </tr>

      <tr *ngIf="filteredProduits.length === 0">
        <td colspan="9" class="text-center text-muted">
          <p>Aucun produit trouv√©</p>
        </td>
      </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div *ngIf="totalPages > 1" class="pagination">
    <button
      class="btn btn-sm"
      [disabled]="currentPage === 1"
      (click)="goToPage(currentPage - 1)"
    >
      ‚Üê Pr√©c√©dent
    </button>

    <span class="page-info">
      Page {{ currentPage }} / {{ totalPages }}
      ({{ filteredProduits.length }} produits)
    </span>

    <button
      class="btn btn-sm"
      [disabled]="currentPage === totalPages"
      (click)="goToPage(currentPage + 1)"
    >
      Suivant ‚Üí
    </button>
  </div>
</div>

<!-- Modal d√©tails produit -->
<div *ngIf="showDetailsModal && selectedProduit" class="modal-overlay" (click)="closeDetailsModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>üì¶ D√©tails du produit</h2>
      <button class="btn-close" (click)="closeDetailsModal()">‚úï</button>
    </div>

    <div class="modal-body">
      <div class="product-details">
        <div *ngIf="selectedProduit.imageProduit" class="product-image-large">
          <img [src]="'http://localhost:8080' + selectedProduit.imageProduit" [alt]="selectedProduit.nomProduit" />
        </div>

        <div class="details-grid">
          <div class="detail-item">
            <strong>Code:</strong>
            <span>{{ selectedProduit.codeProduit }}</span>
          </div>

          <div class="detail-item">
            <strong>Nom:</strong>
            <span>{{ selectedProduit.nomProduit }}</span>
          </div>

          <div class="detail-item">
            <strong>Cat√©gorie:</strong>
            <span>{{ CategorieLabels[selectedProduit.categorieProduit] }}</span>
          </div>

          <div class="detail-item">
            <strong>Type:</strong>
            <span>{{ TypeProduitLabels[selectedProduit.typeProduit] }}</span>
          </div>

          <div class="detail-item">
            <strong>Prix unitaire:</strong>
            <span>{{ selectedProduit.prixUnitaire | number:'1.2-2' }} TND</span>
          </div>

          <div class="detail-item">
            <strong>Quantit√© initiale:</strong>
            <span>{{ selectedProduit.quantiteInitial }}</span>
          </div>

          <div class="detail-item">
            <strong>Stock disponible:</strong>
            <span [class]="getStockStatusClass(selectedProduit)">
              {{ selectedProduit.quantiteDisponible }}
            </span>
          </div>

          <div class="detail-item">
            <strong>Seuil critique:</strong>
            <span>{{ selectedProduit.seuilCritique }}</span>
          </div>

          <div class="detail-item">
            <strong>Maintenance requise:</strong>
            <span>{{ selectedProduit.maintenanceRequise ? 'Oui' : 'Non' }}</span>
          </div>

          <div class="detail-item">
            <strong>En stock:</strong>
            <span [class.text-success]="selectedProduit.enStock" [class.text-danger]="!selectedProduit.enStock">
              {{ selectedProduit.enStock ? 'Oui' : 'Non' }}
            </span>
          </div>

          <div *ngIf="selectedProduit.descriptionProduit" class="detail-item full-width">
            <strong>Description:</strong>
            <p>{{ selectedProduit.descriptionProduit }}</p>
          </div>

          <div class="detail-item">
            <strong>Cr√©√© le:</strong>
            <span>{{ selectedProduit.dateCreation | date:'dd/MM/yyyy HH:mm' }}</span>
          </div>

          <div class="detail-item">
            <strong>Modifi√© le:</strong>
            <span>{{ selectedProduit.dateDerniereModification | date:'dd/MM/yyyy HH:mm' }}</span>
          </div>

          <div *ngIf="selectedProduit.nombreReservations" class="detail-item">
            <strong>Nombre de r√©servations:</strong>
            <span>{{ selectedProduit.nombreReservations }}</span>
          </div>

          <div *ngIf="selectedProduit.moyenneNotes" class="detail-item">
            <strong>Note moyenne:</strong>
            <span>{{ selectedProduit.moyenneNotes | number:'1.1-1' }} / 5 ‚≠ê ({{ selectedProduit.nombreAvis }} avis)</span>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-primary" (click)="goToEdit(selectedProduit.idProduit)">
        ‚úèÔ∏è Modifier
      </button>
      <button
        *ngIf="selectedProduit.typeProduit === TypeProduit.AVEC_REFERENCE"
        class="btn btn-secondary"
        (click)="goToInstances(selectedProduit)"
      >
        üî¢ G√©rer les instances
      </button>
      <button class="btn btn-warning" (click)="goToMouvements(selectedProduit.idProduit)">
        üìä Historique
      </button>
      <button class="btn btn-secondary" (click)="closeDetailsModal()">
        Fermer
      </button>
    </div>
  </div>
</div>
