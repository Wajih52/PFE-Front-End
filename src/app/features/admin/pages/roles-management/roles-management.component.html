<!-- src/app/features/admin/pages/roles-management/roles-management.component.html -->

<div class="roles-management-container">

  <!-- Header -->
  <header class="page-header">
    <div>
      <h1>üé≠ Gestion des R√¥les</h1>
      <p class="subtitle">Configuration et contr√¥le des r√¥les syst√®me</p>
    </div>
    <button class="btn-primary" (click)="openAddModal()">
      + Nouveau r√¥le
    </button>
  </header>

  <!-- Statistiques -->
  <div class="stats-grid">
    <div class="stat-card total">
      <div class="stat-icon">üìä</div>
      <div class="stat-content">
        <h3>{{ stats.total }}</h3>
        <p>Total r√¥les</p>
      </div>
    </div>

    <div class="stat-card actif">
      <div class="stat-icon">‚úÖ</div>
      <div class="stat-content">
        <h3>{{ stats.actifs }}</h3>
        <p>R√¥les actifs</p>
      </div>
    </div>

    <div class="stat-card inactif">
      <div class="stat-icon">üîí</div>
      <div class="stat-content">
        <h3>{{ stats.inactifs }}</h3>
        <p>R√¥les inactifs</p>
      </div>
    </div>

    <div class="stat-card recent">
      <div class="stat-icon">üÜï</div>
      <div class="stat-content">
        <h3>{{ stats.recentlyAdded }}</h3>
        <p>Ajout√©s r√©cemment</p>
      </div>
    </div>
  </div>

  <!-- Messages -->
  <div class="alert alert-success" *ngIf="successMessage">
    {{ successMessage }}
  </div>
  <div class="alert alert-error" *ngIf="errorMessage">
    {{ errorMessage }}
  </div>

  <!-- Filtres et Recherche -->
  <div class="filters-card">
    <div class="search-bar">
      <input
        type="text"
        [(ngModel)]="searchTerm"
        (input)="applyFilters()"
        placeholder="üîç Rechercher par nom ou description..."
        class="search-input"
      >
    </div>

    <div class="filters-row">
      <button class="btn-reset" (click)="resetFilters()">
        üîÑ R√©initialiser
      </button>
    </div>

    <div class="results-info">
      <p>{{ filteredRoles.length }} r√©sultat(s) trouv√©(s)</p>
    </div>
  </div>

  <!-- Loader -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner"></div>
    <p>Chargement des r√¥les...</p>
  </div>

  <!-- Tableau -->
  <div *ngIf="!isLoading" class="table-card">
    <div class="table-wrapper">
      <table class="roles-table">
        <thead>
        <tr>
          <th (click)="sortBy('id')" class="sortable">
            ID
            <span class="sort-icon" *ngIf="sortColumn === 'id'">
              {{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}
            </span>
          </th>
          <th (click)="sortBy('nom')" class="sortable">
            Nom
            <span class="sort-icon" *ngIf="sortColumn === 'nom'">
              {{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}
            </span>
          </th>
          <th>Description</th>
          <th (click)="sortBy('creationDate')" class="sortable">
            Date de cr√©ation
            <span class="sort-icon" *ngIf="sortColumn === 'creationDate'">
              {{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}
            </span>
          </th>
          <th (click)="sortBy('modificationDate')" class="sortable">
            Derni√®re modification
            <span class="sort-icon" *ngIf="sortColumn === 'modificationDate'">
              {{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}
            </span>
          </th>
          <th (click)="sortBy('active')" class="sortable">
            Statut
            <span class="sort-icon" *ngIf="sortColumn === 'active'">
              {{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}
            </span>
          </th>
          <th class="actions-column">Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr *ngFor="let role of paginatedRoles">
          <td>
            <span class="code-badge">{{ role.id }}</span>
          </td>
          <td>
            <strong>{{ role.nom }}</strong>
          </td>
          <td>
            <span class="description-text">
              {{ role.description || 'Aucune description' }}
            </span>
          </td>
          <td>
            {{ formatDate(role.creationDate) }}
          </td>
          <td>
            {{ formatDate(role.modificationDate) }}
          </td>
          <td>
            <span class="statut-badge" [class.active]="role.active" [class.inactive]="!role.active">
              {{ role.active ? '‚úÖ Actif' : 'üîí Inactif' }}
            </span>
          </td>
          <td class="actions-cell">
            <div class="action-buttons">
              <button
                class="btn-action btn-users"
                (click)="showUsersForRole(role)"
                title="Voir les utilisateurs"
              >
                üë•
              </button>
              <button
                class="btn-action btn-edit"
                (click)="openEditModal(role)"
                title="Modifier"
              >
                ‚úèÔ∏è
              </button>
              <button
                class="btn-action btn-delete"
                (click)="deleteRole(role)"
                title="Supprimer"
              >
                üóëÔ∏è
              </button>
            </div>
          </td>
        </tr>
        </tbody>
      </table>

      <!-- Pagination -->
      <div class="pagination" *ngIf="totalPages > 1">
        <button
          class="pagination-btn"
          (click)="prevPage()"
          [disabled]="currentPage === 1"
        >
          ‚Üê Pr√©c√©dent
        </button>

        <div class="pagination-numbers">
          <button
            *ngFor="let page of [].constructor(totalPages); let i = index"
            class="pagination-number"
            [class.active]="currentPage === i + 1"
            (click)="goToPage(i + 1)"
          >
            {{ i + 1 }}
          </button>
        </div>

        <button
          class="pagination-btn"
          (click)="nextPage()"
          [disabled]="currentPage === totalPages"
        >
          Suivant ‚Üí
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Ajout -->
  <div class="modal-overlay" *ngIf="showAddModal" (click)="closeAddModal()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <button class="modal-close" (click)="closeAddModal()">‚úñ</button>

      <div class="modal-header">
        <h2>‚ûï Ajouter un nouveau r√¥le</h2>
      </div>

      <div class="modal-content">
        <form [formGroup]="roleForm" (ngSubmit)="saveRole()">

          <div class="form-field">
            <label>Nom du r√¥le *</label>
            <input
              type="text"
              formControlName="nom"
              placeholder="Ex: MANAGER, SUPERVISEUR, etc."
            />
            <span class="error-message" *ngIf="getErrorMessage('nom', roleForm)">
              {{ getErrorMessage('nom', roleForm) }}
            </span>
          </div>

          <div class="form-field">
            <label>Description</label>
            <textarea
              formControlName="description"
              placeholder="Description du r√¥le et de ses responsabilit√©s..."
              rows="4"
            ></textarea>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn-cancel" (click)="closeAddModal()">
              Annuler
            </button>
            <button
              type="submit"
              class="btn-save"
              [disabled]="isSubmitting || roleForm.invalid"
            >
              {{ isSubmitting ? 'Cr√©ation...' : 'Cr√©er le r√¥le' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal √âdition -->
  <div class="modal-overlay" *ngIf="showEditModal" (click)="closeEditModal()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <button class="modal-close" (click)="closeEditModal()">‚úñ</button>

      <div class="modal-header">
        <h2>‚úèÔ∏è Modifier le r√¥le</h2>
      </div>

      <div class="modal-content">
        <form [formGroup]="editForm" (ngSubmit)="updateRole()">

          <div class="form-field">
            <label>Nom du r√¥le *</label>
            <input
              type="text"
              formControlName="nom"
              placeholder="Nom du r√¥le"
            />
            <span class="error-message" *ngIf="getErrorMessage('nom', editForm)">
              {{ getErrorMessage('nom', editForm) }}
            </span>
          </div>

          <div class="form-field">
            <label>Description</label>
            <textarea
              formControlName="description"
              placeholder="Description du r√¥le et de ses responsabilit√©s..."
              rows="4"
            ></textarea>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn-cancel" (click)="closeEditModal()">
              Annuler
            </button>
            <button
              type="submit"
              class="btn-save"
              [disabled]="isSubmitting || editForm.invalid"
            >
              {{ isSubmitting ? 'Modification...' : 'Enregistrer' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal Utilisateurs -->
  <div class="modal-overlay" *ngIf="showUsersModal" (click)="closeUsersModal()">
    <div class="modal-container modal-large" (click)="$event.stopPropagation()">
      <button class="modal-close" (click)="closeUsersModal()">‚úñ</button>

      <div class="modal-header">
        <h2>üë• Utilisateurs avec le r√¥le "{{ selectedRole?.nom }}"</h2>
      </div>

      <div class="modal-content">
        <div *ngIf="usersForSelectedRole.length === 0" class="empty-state">
          <p> Aucun utilisateur n'a ce r√¥le pour le moment</p>
        </div>

        <div *ngIf="usersForSelectedRole.length > 0" class="users-list">
          <div class="user-item" *ngFor="let userRole of usersForSelectedRole">
            <div class="user-avatar">
              <img
                *ngIf="userRole.utilisateur.image"
                [src]="getImageUrl(userRole.utilisateur.image)"
                alt="Photo de {{ userRole.utilisateur?.prenom }} {{ userRole.utilisateur?.nom }}"
                (error)="onImageError($event)"
                (click)="openImageModal(userRole.utilisateur.image)"
              />
              <div *ngIf="!userRole.utilisateur.image" class="avatar-placeholder">
                {{ (userRole.utilisateur.prenom?.charAt(0) || '') + (userRole.utilisateur.nom?.charAt(0) || '')}}
              </div>
            </div>
            <div class="user-info">
              <h4>{{ userRole.utilisateur.nom }} {{ userRole.utilisateur.prenom }}</h4>
              <p>üìß {{ userRole.utilisateur.email }}</p>
              <p>üìû {{ userRole.utilisateur.telephone }}</p>
            </div>
            <div class="user-meta">
              <span class="date-badge">
                Assign√© le: {{ formatDate(userRole.dateAffectationRole) }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal Image Agrandie -->
  <div class="modal-overlay" *ngIf="showImageModal" (click)="closeImageModal()">
    <div class="image-modal-container" (click)="$event.stopPropagation()">
      <button class="modal-close" (click)="closeImageModal()">‚úñ</button>

      <div class="image-modal-content">
        <img
          [src]="selectedImage"
          alt="Image agrandie"
          (error)="onImageError($event)"
          class="enlarged-image"
          [class.zoomed]="isZoomed"
          (click)="isZoomed = !isZoomed"
        />
      </div>

      <div class="image-modal-actions">
        <button class="btn-download" (click)="downloadImage(selectedImage)">
          üì• T√©l√©charger
        </button>
        <button class="btn-close" (click)="closeImageModal()">
          Fermer
        </button>
      </div>
    </div>
  </div>

</div>
