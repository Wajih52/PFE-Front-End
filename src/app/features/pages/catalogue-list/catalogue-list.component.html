<!-- src/app/features/pages/catalogue-list/catalogue-list.component.html -->
<!-- âœ… VERSION CORRIGÃ‰E - Tous les problÃ¨mes UI rÃ©solus -->

<div class="catalogue-container">

  <!-- ========== HEADER ========== -->
  <div class="catalogue-header">
    <h1>Notre Catalogue</h1>
    <p class="subtitle">DÃ©couvrez notre sÃ©lection de produits disponibles pour vos Ã©vÃ©nements</p>

    <!-- ðŸŽ¯ SÃ‰LECTEUR DE DATES CRITIQUES -->
    <div class="date-selector">
      <div class="date-input-group">
        <label for="dateDebut">
          <i class="fas fa-calendar-alt"></i>
          Date de dÃ©but
        </label>
        <input
          type="date"
          id="dateDebut"
          [(ngModel)]="dateDebutLocation"
          (change)="onDatesChange()"
          class="date-input"
          [min]="minDate"
        />
      </div>

      <div class="date-input-group">
        <label for="dateFin">
          <i class="fas fa-calendar-check"></i>
          Date de fin
        </label>
        <input
          type="date"
          id="dateFin"
          [(ngModel)]="dateFinLocation"
          (change)="onDatesChange()"
          class="date-input"
          [min]="dateDebutLocation"
        />
      </div>

      <button
        class="btn-refresh"
        (click)="chargerCatalogue()"
        title="RafraÃ®chir"
        [disabled]="!dateDebutLocation || !dateFinLocation || isDateDebutSuperieureDateFin()"
      >
        <i class="fas fa-sync-alt"></i>
        Rechercher
      </button>
    </div>

    <!-- Badge Panier -->
    <a routerLink="/client/panier" class="panier-badge">
      <i class="fas fa-shopping-cart"></i>
      @if (nombreProduits() > 0) {
        <span class="badge">{{ nombreProduits() }}</span>
      }
    </a>
  </div>

  <!-- ========== MESSAGE D'ERREUR ========== -->
  @if (errorMessage()) {
    <div class="error-message">
      <i class="fas fa-exclamation-triangle"></i>
      {{ errorMessage() }}
    </div>
  }

  <!-- ========== LOADING ========== -->
  @if (isLoading()) {
    <div class="loading-container">
      <div class="loader"></div>
      <p>Chargement des produits disponibles...</p>
    </div>
  }

  <!-- ========== CONTENU PRINCIPAL ========== -->
  @if (!isLoading()) {
    <div class="catalogue-content">

      <!-- ========== SIDEBAR FILTRES ========== -->
      <aside class="filtres-sidebar">
        <div class="filtre-section">
          <h3>
            <i class="fas fa-filter"></i>
            Filtres
          </h3>

          <!-- Recherche par nom -->
          <div class="filtre-group">
            <label for="recherche">Rechercher un produit</label>
            <input
              type="text"
              id="recherche"
              placeholder="Nom du produit..."
              [(ngModel)]="rechercheNom"
              class="search-input"
            />
          </div>

          <!-- âœ… FIX #2: CatÃ©gories avec sÃ©lection fonctionnelle -->
          <div class="filtre-group">
            <label>CatÃ©gories</label>
            <div class="categorie-list">
              <button
                class="categorie-btn"
                [class.active]="categorieSelectionnee() === null"
                (click)="selectionnerCategorie(null)"
              >
                <i class="fas fa-th"></i>
                Toutes
              </button>

              @for (categorie of categories; track categorie) {
                <button
                  class="categorie-btn"
                  [class.active]="categorieSelectionnee() === categorie"
                  (click)="selectionnerCategorie(categorie)"
                >
                  {{ getCategorieLabel(categorie) }}
                </button>
              }
            </div>
          </div>

          <!-- Filtre prix -->
          <div class="filtre-group">
            <label>
              <i class="fas fa-tag"></i>
              Prix (TND)
            </label>

            <div class="prix-range">
              <div class="prix-input-group">
                <label for="prixMin" class="small-label">Min</label>
                <input
                  type="number"
                  id="prixMin"
                  [(ngModel)]="prixMin"
                  placeholder="0"
                  min="0"
                  class="prix-input"
                />
              </div>

              <span class="prix-separator">â€”</span>

              <div class="prix-input-group">
                <label for="prixMax" class="small-label">Max</label>
                <input
                  type="number"
                  id="prixMax"
                  [(ngModel)]="prixMax"
                  placeholder="1000"
                  min="0"
                  class="prix-input"
                />
              </div>
            </div>
          </div>

          <!-- Bouton rÃ©initialiser -->
          <button class="btn-reset" (click)="reinitialiserFiltres()">
            <i class="fas fa-redo"></i>
            RÃ©initialiser les filtres
          </button>
        </div>
      </aside>

      <!-- ========== GRILLE DE PRODUITS ========== -->
      <main class="produits-grid-container">

        <!-- âœ… FIX #5: Header avec tri Ã  droite -->
        <div class="resultats-header">
          <div class="resultats-info">
            <p>
              <strong>{{ produitsFiltres().length }}</strong>
              produit{{ produitsFiltres().length > 1 ? 's' : '' }} disponible{{ produitsFiltres().length > 1 ? 's' : '' }}
              <br>
              Du <strong>{{ dateDebutLocation }}</strong> au <strong>{{ dateFinLocation }}</strong>
            </p>
          </div>

          <!-- âœ… FIX #3 & #5: Tri stylisÃ© et positionnÃ© Ã  droite -->
          <div class="tri-container">
            <label for="tri">
              <i class="fas fa-sort"></i>
              Trier par
            </label>
            <select
              id="tri"
              [(ngModel)]="triSelectionne"
              class="select-tri"
            >
              <option value="">Par dÃ©faut</option>
              <option value="prix-asc">Prix croissant â†‘</option>
              <option value="prix-desc">Prix dÃ©croissant â†“</option>
              <option value="nom-asc">Nom Aâ†’Z</option>
              <option value="nom-desc">Nom Zâ†’A</option>
            </select>
          </div>
        </div>

        <!-- Aucun produit trouvÃ© -->
        @if (produitsFiltres().length === 0) {
          <div class="empty-state">
            <i class="fas fa-inbox"></i>
            <h3>Aucun produit disponible</h3>
            <p>Essayez de modifier vos dates ou vos filtres de recherche.</p>
          </div>
        }

        <!-- Grille de produits -->
        @if (produitsFiltres().length > 0) {
          <div class="produits-grid">
            @for (produit of produitsFiltres(); track produit.idProduit) {
              <div class="product-card">

                <!-- Image -->
                <div class="product-image" (click)="voirDetails(produit.idProduit)">
                  <img
                    [src]="getImageUrl(produit)"
                    [alt]="produit.nomProduit"
                    (error)="onImageError($event)"
                  />

                  <!-- âœ… FIX #4: Badge de quantitÃ© visible et fonctionnel -->
                  @if (getQuantiteDisponible(produit.idProduit) !== null) {
                    @if (getQuantiteDisponible(produit.idProduit) === 0) {
                      <div class="badge-disponibilite indisponible">
                        <i class="fas fa-times-circle"></i>
                        Indisponible
                      </div>
                    } @else if (getQuantiteDisponible(produit.idProduit)! <= 5) {
                      <div class="badge-disponibilite stock-faible">
                        <i class="fas fa-exclamation-circle"></i>
                        {{ getQuantiteDisponible(produit.idProduit) }} restant(s)
                      </div>
                    } @else {
                      <div class="badge-disponibilite disponible">
                        <i class="fas fa-check-circle"></i>
                        {{ getQuantiteDisponible(produit.idProduit) }} disponible(s)
                      </div>
                    }
                  }

                  <!-- Badge catÃ©gorie -->
                  <div class="badge-categorie">
                    {{ getCategorieLabel(produit.categorieProduit) }}
                  </div>
                </div>

                <!-- Contenu -->
                <div class="product-content">
                  <h3 class="product-name" (click)="voirDetails(produit.idProduit)">
                    {{ produit.nomProduit }}
                  </h3>

                  <p class="product-description">
                    {{ produit.descriptionProduit || 'Aucune description disponible' }}
                  </p>

                  <!-- Footer avec prix et actions -->
                  <div class="product-footer">
                    <div class="product-price">
                      <span class="price-amount">{{ produit.prixUnitaire | number:'1.2-2' }} TND</span>
                      <span class="price-unit">/ jour</span>
                    </div>

                    <div class="product-actions">
                      <!-- Bouton voir dÃ©tails -->
                      <button
                        class="btn-view"
                        (click)="voirDetails(produit.idProduit)"
                        title="Voir les dÃ©tails"
                      >
                        <i class="fas fa-eye"></i>
                      </button>

                      <!-- âœ… FIX #6: Bouton ajouter dÃ©sactivÃ© si indisponible -->
                      <button
                        class="btn-add-cart"
                        (click)="ajouterAuPanier(produit)"
                        [disabled]="!peutAjouterAuPanier(produit)"
                        [title]="!peutAjouterAuPanier(produit) ? 'Produit indisponible' : 'Ajouter au panier'"
                      >
                        <i class="fas fa-shopping-cart"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            }
          </div>
        }
      </main>
    </div>
  }
</div>
