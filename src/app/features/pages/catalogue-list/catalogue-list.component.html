<!-- src/app/features/pages/catalogue-list/catalogue-list.component.html -->
<!-- VERSION CORRIG√âE - Avec s√©lecteur de dates -->

<div class="catalogue-container">

  <!-- ========== HEADER ========== -->
  <div class="catalogue-header">
    <h1>Notre Catalogue</h1>
    <p class="subtitle">D√©couvrez notre s√©lection de produits disponibles pour vos √©v√©nements</p>

    <!-- üéØ S√âLECTEUR DE DATES CRITIQUES -->
    <div class="date-selector">
      <div class="date-input-group">
        <label for="dateDebut">
          <i class="fas fa-calendar-alt"></i>
          Date de d√©but
        </label>
        <input
          type="date"
          id="dateDebut"
          [(ngModel)]="dateDebutLocation"
          (change)="onDatesChange()"
          class="date-input"
          [min]="minDate"
        />
      </div>

      <div class="date-input-group">
        <label for="dateFin">
          <i class="fas fa-calendar-check"></i>
          Date de fin
        </label>
        <input
          type="date"
          id="dateFin"
          [(ngModel)]="dateFinLocation"
          (change)="onDatesChange()"
          class="date-input"
          [min]="dateDebutLocation"
        />
      </div>

      <button class="btn-refresh" (click)="chargerCatalogue()" title="Rafra√Æchir">
        <i class="fas fa-sync-alt"></i>
        Rechercher
      </button>
    </div>

    <!-- Badge Panier -->
    <a [routerLink]="['/panier']" class="panier-badge">
      <i class="fas fa-shopping-cart"></i>
      @if (totalPanier() > 0) {
        <span class="badge">{{ totalPanier() }}</span>
      }
    </a>
  </div>

  <!-- ========== MESSAGE D'ERREUR ========== -->
  @if (errorMessage()) {
    <div class="error-message">
      <i class="fas fa-exclamation-triangle"></i>
      {{ errorMessage() }}
    </div>
  }

  <!-- ========== LOADING ========== -->
  @if (isLoading()) {
    <div class="loading-container">
      <div class="loader"></div>
      <p>Chargement des produits disponibles...</p>
    </div>
  }

  <!-- ========== CONTENU PRINCIPAL ========== -->
  @if (!isLoading()) {
    <div class="catalogue-content">

      <!-- ========== SIDEBAR FILTRES ========== -->
      <aside class="filtres-sidebar">
        <div class="filtre-section">
          <h3>
            <i class="fas fa-filter"></i>
            Filtres
          </h3>

          <!-- Recherche par nom -->
          <div class="filtre-group">
            <label for="recherche">Rechercher un produit</label>
            <input
              type="text"
              id="recherche"
              placeholder="Nom du produit..."
              [(ngModel)]="rechercheNom"
              class="search-input"
            />
          </div>

          <!-- Cat√©gories -->
          <div class="filtre-group">
            <label>Cat√©gories</label>
            <div class="categorie-list">
              <button
                class="categorie-btn"
                [class.active]="categorieSelectionnee() === null"
                (click)="reinitialiserFiltres()"
              >
                <i class="fas fa-th"></i>
                Toutes
              </button>

              @for (categorie of categories; track categorie) {
                <button
                  class="categorie-btn"
                  [class.active]="categorieSelectionnee() === categorie"
                  (click)="filtrerParCategorie(categorie)"
                >
                  {{ getCategorieLabel(categorie) }}
                </button>
              }
            </div>
          </div>

          <!-- Bouton r√©initialiser -->
          <button class="btn-reset" (click)="reinitialiserFiltres()">
            <i class="fas fa-redo"></i>
            R√©initialiser les filtres
          </button>
        </div>
      </aside>

      <!-- ========== GRILLE DE PRODUITS ========== -->
      <main class="produits-grid-container">
        <div class="resultats-header">
          <p>
            <strong>{{ produitsFiltres().length }}</strong>
            produit{{ produitsFiltres().length > 1 ? 's' : '' }} disponible{{ produitsFiltres().length > 1 ? 's' : '' }}
            <br>
            Du <strong>{{ dateDebutLocation }}</strong>   au   <strong>{{ dateFinLocation }}</strong>
          </p>
        </div>

        <!-- Aucun produit trouv√© -->
        @if (produitsFiltres().length === 0) {
          <div class="empty-state">
            <i class="fas fa-inbox"></i>
            <h3>Aucun produit disponible</h3>
            <p>Essayez de modifier vos dates ou vos filtres de recherche.</p>
          </div>
        }

        <!-- Grille de produits -->
        @if (produitsFiltres().length > 0) {
          <div class="produits-grid">
            @for (produit of produitsFiltres(); track produit.idProduit) {
              <div class="product-card">
                <!-- Image -->
                <div class="product-image" (click)="voirDetails(produit.idProduit)">
                  <img
                    [src]="getImageUrl(produit)"
                    [alt]="produit.nomProduit"
                    (error)="onImageError($event)"
                  />

                  <!-- Badge stock -->
                  <div class="stock-badge" [class.low-stock]="produit.quantiteDisponible <= produit.seuilCritique">
                    <i class="fas fa-box"></i>
                    {{ produit.quantiteDisponible }} disponible{{ produit.quantiteDisponible > 1 ? 's' : '' }}
                  </div>
                </div>

                <!-- Infos produit -->
                <div class="product-info">
                  <span class="product-category">
                    {{ getCategorieLabel(produit.categorieProduit) }}
                  </span>

                  <h3 class="product-name" (click)="voirDetails(produit.idProduit)">
                    {{ produit.nomProduit }}
                  </h3>

                  @if (produit.descriptionProduit) {
                    <p class="product-description">
                      {{ produit.descriptionProduit.substring(0, 80) }}
                      {{ produit.descriptionProduit.length > 80 ? '...' : '' }}
                    </p>
                  }

                  <div class="product-footer">
                    <div class="product-price">
                      {{ produit.prixUnitaire.toFixed(2) }} TND
                      <span class="price-unit">/ jour</span>
                    </div>

                    <div class="product-actions">
                      <button
                        class="btn-view"
                        (click)="voirDetails(produit.idProduit)"
                        title="Voir les d√©tails"
                      >
                        <i class="fas fa-eye"></i>
                      </button>

                      <button
                        class="btn-add-cart"
                        (click)="ajouterAuPanier(produit)"
                        [disabled]="produit.quantiteDisponible === 0"
                        title="Ajouter au panier"
                      >
                        <i class="fas fa-cart-plus"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            }
          </div>
        }
      </main>
    </div>
  }
</div>
