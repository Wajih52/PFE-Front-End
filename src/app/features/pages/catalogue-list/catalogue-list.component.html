<!-- src/app/features/pages/catalogue-list/catalogue-list.component.html -->
<!-- VERSION CORRIGÃ‰E - Avec sÃ©lecteur de dates -->

<div class="catalogue-container">

  <!-- ========== HEADER ========== -->
  <div class="catalogue-header">
    <h1>Notre Catalogue</h1>
    <p class="subtitle">DÃ©couvrez notre sÃ©lection de produits disponibles pour vos Ã©vÃ©nements</p>

    <!-- ðŸŽ¯ SÃ‰LECTEUR DE DATES CRITIQUES -->
    <div class="date-selector">
      <div class="date-input-group">
        <label for="dateDebut">
          <i class="fas fa-calendar-alt"></i>
          Date de dÃ©but
        </label>
        <input
          type="date"
          id="dateDebut"
          [(ngModel)]="dateDebutLocation"
          (change)="onDatesChange()"
          class="date-input"
          [min]="minDate"
        />
      </div>

      <div class="date-input-group">
        <label for="dateFin">
          <i class="fas fa-calendar-check"></i>
          Date de fin
        </label>
        <input
          type="date"
          id="dateFin"
          [(ngModel)]="dateFinLocation"
          (change)="onDatesChange()"
          class="date-input"
          [min]="dateDebutLocation"
        />
      </div>

      <button class="btn-refresh" (click)="chargerCatalogue()" title="RafraÃ®chir">
        <i class="fas fa-sync-alt"></i>
        Rechercher
      </button>
    </div>

    <!-- Badge Panier -->
    <a [routerLink]="['/panier']" class="panier-badge">
      <i class="fas fa-shopping-cart"></i>
      @if (nombreProduits() > 0) {
        <span class="badge">{{ nombreProduits() }}</span>
      }
    </a>
  </div>

  <!-- ========== MESSAGE D'ERREUR ========== -->
  @if (errorMessage()) {
    <div class="error-message">
      <i class="fas fa-exclamation-triangle"></i>
      {{ errorMessage() }}
    </div>
  }

  <!-- ========== LOADING ========== -->
  @if (isLoading()) {
    <div class="loading-container">
      <div class="loader"></div>
      <p>Chargement des produits disponibles...</p>
    </div>
  }

  <!-- ========== CONTENU PRINCIPAL ========== -->
  @if (!isLoading()) {
    <div class="catalogue-content">

      <!-- ========== SIDEBAR FILTRES ========== -->
      <aside class="filtres-sidebar">
        <div class="filtre-section">
          <h3>
            <i class="fas fa-filter"></i>
            Filtres
          </h3>

          <!-- Recherche par nom -->
          <div class="filtre-group">
            <label for="recherche">Rechercher un produit</label>
            <input
              type="text"
              id="recherche"
              placeholder="Nom du produit..."
              [(ngModel)]="rechercheNom"
              (input)="appliquerFiltres()"
              class="search-input"
            />
          </div>


          <!-- CatÃ©gories -->
          <div class="filtre-group">
            <label>CatÃ©gories</label>
            <div class="categorie-list">
              <button
                class="categorie-btn"
                [class.active]="categorieSelectionnee() === null"
                (click)="reinitialiserFiltres()"
                (change)="appliquerFiltres()"
              >
                <i class="fas fa-th"></i>
                Toutes
              </button>

              @for (categorie of categories; track categorie) {
                <button
                  class="categorie-btn"
                  [class.active]="categorieSelectionnee() === categorie"
                  (click)="appliquerFiltres()"
                >
                  {{ getCategorieLabel(categorie) }}
                </button>
              }
            </div>
          </div>
          <div class="filtre-group">
            <label>
              <i class="fas fa-tag"></i>
              Prix (TND)
            </label>

            <div class="prix-range">
              <div class="prix-input-group">
                <label for="prixMin" class="small-label">Min</label>
                <input
                  type="number"
                  id="prixMin"
                  [(ngModel)]="prixMin"
                  (input)="appliquerFiltres()"
                  placeholder="0"
                  min="0"
                  class="prix-input"
                />
              </div>

              <span class="prix-separator">â€”</span>

              <div class="prix-input-group">
                <label for="prixMax" class="small-label">Max</label>
                <input
                  type="number"
                  id="prixMax"
                  [(ngModel)]="prixMax"
                  (input)="appliquerFiltres()"
                  placeholder="1000"
                  min="0"
                  class="prix-input"
                />
              </div>
            </div>
          </div>

          <!-- â­ NOUVEAU: Tri -->
          <div class="filtre-group">
            <label for="tri">
              <i class="fas fa-sort"></i>
              Trier par
            </label>
            <select
              id="tri"
              [(ngModel)]="triSelectionne"
              (change)="appliquerFiltres()"
              class="select-input"
            >
              <option value="">Aucun tri</option>
              <option value="prix-asc">Prix croissant (â†‘)</option>
              <option value="prix-desc">Prix dÃ©croissant (â†“)</option>
              <option value="nom-asc">Nom Aâ†’Z</option>
              <option value="nom-desc">Nom Zâ†’A</option>
            </select>
          </div>
          <!-- Bouton rÃ©initialiser -->
          <button class="btn-reset" (click)="reinitialiserFiltres()">
            <i class="fas fa-redo"></i>
            RÃ©initialiser les filtres
          </button>
        </div>
      </aside>

      <!-- ========== GRILLE DE PRODUITS ========== -->
      <main class="produits-grid-container">
        <div class="resultats-header">
          <p>
            <strong>{{ produitsFiltres().length }}</strong>
            produit{{ produitsFiltres().length > 1 ? 's' : '' }} disponible{{ produitsFiltres().length > 1 ? 's' : '' }}
            <br>
            Du <strong>{{ dateDebutLocation }}</strong> au <strong>{{ dateFinLocation }}</strong>
          </p>
        </div>

        <!-- Aucun produit trouvÃ© -->
        @if (produitsFiltres().length === 0) {
          <div class="empty-state">
            <i class="fas fa-inbox"></i>
            <h3>Aucun produit disponible</h3>
            <p>Essayez de modifier vos dates ou vos filtres de recherche.</p>
          </div>
        }

        <!-- Grille de produits -->
        @if (produitsFiltres().length > 0) {
          <div class="produits-grid">
            @for (produit of produitsFiltres(); track produit.idProduit) {
              <div class="product-card">
                <!-- Image -->
                <div class="product-image" (click)="voirDetails(produit.idProduit)">
                  <img
                    [src]="getImageUrl(produit)"
                    [alt]="produit.nomProduit"
                    (error)="onImageError($event)"
                  />

                  <!-- â­  Badge disponibilitÃ© dynamique -->
                  <div class="disponibilite-badge">
                    @if (getQuantiteDisponible(produit.idProduit) !== null) {
                      @if (getQuantiteDisponible(produit.idProduit) === 0) {
                        <!-- Rupture de stock -->
                        <span class="badge-rupture">
                        <i class="fas fa-times-circle"></i>
                         Indisponible
                        </span>
                      } @else if (getQuantiteDisponible(produit.idProduit)! < 10) {
                        <!-- Stock limitÃ© -->
                        <span class="badge-limite">
            <i class="fas fa-exclamation-triangle"></i>
                          {{ getQuantiteDisponible(produit.idProduit) }} restant(s)
          </span>
                      } @else {
                        <!-- Stock OK -->
                        <span class="badge-disponible">
            <i class="fas fa-check-circle"></i>
                          {{ getQuantiteDisponible(produit.idProduit) }} disponible(s)
          </span>
                      }
                    } @else {
                      <!-- Chargement ou pas de dates -->
                      <span class="badge-neutre">
                    <i class="fas fa-info-circle"></i>
                        {{ produit.quantiteDisponible }} en stock
                     </span>
                    }
                  </div>
                </div>

                <!-- Infos produit -->
                <div class="product-info">
                  <span class="product-category">
                    {{ getCategorieLabel(produit.categorieProduit) }}
                  </span>

                  <h3 class="product-name" (click)="voirDetails(produit.idProduit)">
                    {{ produit.nomProduit }}
                  </h3>

                  @if (produit.descriptionProduit) {
                    <p class="product-description">
                      {{ produit.descriptionProduit.substring(0, 80) }}
                      {{ produit.descriptionProduit.length > 80 ? '...' : '' }}
                    </p>
                  }

                  <div class="product-footer">
                    <div class="product-price">
                      {{ produit.prixUnitaire.toFixed(2) }} TND
                      <span class="price-unit">/ jour</span>
                    </div>

                    <div class="product-actions">
                      <button
                        class="btn-view"
                        (click)="voirDetails(produit.idProduit)"
                        title="Voir les dÃ©tails"
                      >
                        <i class="fas fa-eye"></i>
                      </button>

                      <button
                        class="btn-add-cart"
                        (click)="ajouterAuPanier(produit)"
                        [disabled]="produit.quantiteDisponible === 0"
                        title="Ajouter au panier"
                      >
                        <i class="fas fa-cart-plus"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            }
          </div>
        }
      </main>
    </div>
  }
</div>
