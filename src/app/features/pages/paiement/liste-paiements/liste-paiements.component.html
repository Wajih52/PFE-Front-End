<div class="paiements-container">
  <div class="page-header">
    <h1>üí≥ Gestion des Paiements</h1>
    <button class="btn btn-primary" (click)="chargerPaiementsEnAttente()">
      <i class="fa fa-clock"></i> Paiements en attente
    </button>
  </div>

  <div class="filtres-section">
    <div class="filtre-groupe">
      <label>Statut :</label>
      <select [(ngModel)]="filtreStatut" (change)="onFiltreStatutChange()" class="form-control">
        <option value="TOUS">Tous les statuts</option>
        <option [value]="StatutPaiement.EN_ATTENTE">En attente</option>
        <option [value]="StatutPaiement.VALIDE">Valid√©s</option>
        <option [value]="StatutPaiement.REFUSE">Refus√©s</option>
      </select>
    </div>

    <div class="filtre-groupe flex-grow">
      <label>Rechercher :</label>
      <input type="text" [(ngModel)]="filtreRecherche" (input)="onRechercheChange()"
             placeholder="Code paiement, client, r√©servation..." class="form-control" />
    </div>
  </div>

  <div *ngIf="loading" class="text-center my-4">
    <div class="spinner-border" role="status">
      <span class="sr-only">Chargement...</span>
    </div>
  </div>

  <div *ngIf="erreur" class="alert alert-danger">{{ erreur }}</div>

  <div *ngIf="!loading && !erreur" class="table-container">
    <table class="table table-hover">
      <thead>
      <tr>
        <th>Code</th>
        <th>R√©servation</th>
        <th>Client</th>
        <th>Montant</th>
        <th>Mode</th>
        <th>Date</th>
        <th>Statut</th>
        <th>Actions</th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let paiement of paiementsPagines">
        <td><strong>{{ paiement.codePaiement }}</strong></td>
        <td>
          <a [routerLink]="['/admin/reservation-details', paiement.idReservation]">{{ paiement.referenceReservation }}</a>
          <div class="small text-muted">{{ formatMontant(paiement.montantTotalReservation-paiement.montantDejaPayeAvant) }}</div>
        </td>
        <td>
          {{ paiement.prenomClient }} {{ paiement.nomClient }}
          <div class="small text-muted">{{ paiement.emailClient }}</div>
        </td>
        <td>
          <strong>{{ formatMontant(paiement.montantPaiement) }}</strong>
          <div class="small text-muted">Restant: {{ formatMontant(paiement.montantRestantApres) }}</div>
          <div class="progress mt-1" style="height: 5px;">
            <div class="progress-bar" [class.bg-success]="paiement.paiementComplet"
                 [class.bg-info]="!paiement.paiementComplet" [style.width.%]="calculerPourcentagePaye(paiement)">
            </div>
          </div>
        </td>
        <td><span class="badge badge-secondary">{{ paiement.modePaiement }}</span></td>
        <td>
          <div>{{ formatDate(paiement.datePaiement) }}</div>
          <div *ngIf="paiement.dateValidation" class="small text-success">
            Valid√© le {{ formatDate(paiement.dateValidation) }}
          </div>
        </td>
        <td>
            <span class="badge" [ngClass]="getStatutBadgeClass(paiement.statutPaiement)">
              {{ getStatutLabel(paiement.statutPaiement) }}
            </span>
          <div *ngIf="paiement.paiementComplet" class="small text-success mt-1">
            <i class="fa fa-check-circle"></i> Complet
          </div>
        </td>
        <td>
          <div class="btn-group">
            <button *ngIf="paiement.statutPaiement === StatutPaiement.EN_ATTENTE"
                    (click)="validerPaiement(paiement)" class="btn btn-sm btn-success" title="Valider le paiement">
              <i class="fa fa-check"></i>
            </button>
            <button *ngIf="paiement.statutPaiement === StatutPaiement.EN_ATTENTE"
                    (click)="ouvrirModalRefus(paiement)" class="btn btn-sm btn-danger" title="Refuser le paiement">
              <i class="fa fa-times"></i>
            </button>
            <button [routerLink]="['/paiements', paiement.idPaiement]" class="btn btn-sm btn-info"
                    title="Voir d√©tails">
              <i class="fa fa-eye"></i>
            </button>
          </div>
        </td>
      </tr>
      <tr *ngIf="paiementsFiltres.length === 0">
        <td colspan="8" class="text-center text-muted">Aucun paiement trouv√©</td>
      </tr>
      </tbody>
    </table>

    <nav *ngIf="nombrePages > 1" class="mt-3">
      <ul class="pagination justify-content-center">
        <li class="page-item" [class.disabled]="page === 1">
          <a class="page-link" (click)="changePage(page - 1)">Pr√©c√©dent</a>
        </li>
        <li *ngFor="let p of [].constructor(nombrePages); let i = index" class="page-item"
            [class.active]="page === i + 1">
          <a class="page-link" (click)="changePage(i + 1)">{{ i + 1 }}</a>
        </li>
        <li class="page-item" [class.disabled]="page === nombrePages">
          <a class="page-link" (click)="changePage(page + 1)">Suivant</a>
        </li>
      </ul>
    </nav>
  </div>
</div>

<div class="modal" [class.show]="showModalRefus" [style.display]="showModalRefus ? 'block' : 'none'">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Refuser le paiement</h5>
        <button type="button" class="close" (click)="fermerModalRefus()"><span>&times;</span></button>
      </div>
      <div class="modal-body">
        <p *ngIf="paiementARefuser">
          √ätes-vous s√ªr de vouloir refuser le paiement <strong>{{ paiementARefuser.codePaiement }}</strong>
          de <strong>{{ formatMontant(paiementARefuser.montantPaiement) }}</strong> ?
        </p>
        <div class="form-group">
          <label>Motif du refus *</label>
          <textarea [(ngModel)]="motifRefus" class="form-control" rows="4"
                    placeholder="Expliquez pourquoi ce paiement est refus√©..." required></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="fermerModalRefus()">Annuler</button>
        <button type="button" class="btn btn-danger" (click)="confirmerRefus()">Confirmer le refus</button>
      </div>
    </div>
  </div>
</div>

<div class="modal-backdrop fade" [class.show]="showModalRefus" *ngIf="showModalRefus"></div>
