<!-- src/app/features/pages/panier/panier.component.html -->
<!-- ✅ VERSION CORRIGÉE - Problèmes 6-10 résolus -->

<div class="panier-container">

  <!-- ========== HEADER ========== -->
  <div class="panier-header">
    <div class="header-content">
      <h1>
        <i class="fas fa-shopping-cart"></i>
        Mon Panier
      </h1>
      <p class="subtitle">
        {{ totalArticles() }} article(s) · {{ montantTotal() | number:'1.2-2' }} TND
      </p>
    </div>

    <!-- Actions globales -->
    <div class="header-actions">
      <button
        class="btn-secondary"
        (click)="continuerAchats()"
        [disabled]="isCreatingCommande()||isCreatingDevis()"
      >
        <i class="fas fa-arrow-left"></i>
        Continuer mes achats
      </button>

      <button
        class="btn-danger"
        (click)="viderPanier()"
        [disabled]="estVide() || isCreatingCommande()||isCreatingDevis()"
      >
        <i class="fas fa-trash"></i>
        Vider le panier
      </button>
    </div>
  </div>

  <!-- ========== PANIER VIDE ========== -->
  @if (estVide()) {
    <div class="panier-vide">
      <div class="empty-icon">
        <i class="fas fa-shopping-cart"></i>
      </div>
      <h2>Votre panier est vide</h2>
      <p>Découvrez notre catalogue et ajoutez des produits pour votre événement</p>
      <button class="btn-primary" (click)="continuerAchats()">
        <i class="fas fa-store"></i>
        Explorer le catalogue
      </button>
    </div>
  }

  <!-- ========== CONTENU DU PANIER ========== -->
  @if (!estVide()) {
    <div class="panier-content">

      <!-- Colonne gauche : Liste des produits -->
      <div class="panier-liste">

        <!-- ✅ FIX #10: Pas de bouton de vérification, validation automatique -->
        <div class="lignes-container">
          @for (ligne of lignes(); track getCleUnique(ligne)) {
            <div class="ligne-panier" [class.indisponible]="!isLigneDisponible(ligne)">

              <!-- ✅ NOUVEAU CODE - Utiliser la méthode getImageUrl() -->
              <div class="ligne-image">
                <img
                  [src]="getImageUrl(ligne)"
                  [alt]="ligne.nomProduit"
                  (error)="onImageError($event)"
                />

                <!-- ✅ Badge indisponible si nécessaire -->
                @if (!isLigneDisponible(ligne)) {
                  <div class="badge-indisponible">
                    <i class="fas fa-exclamation-triangle"></i>
                    Indisponible
                  </div>
                }
              </div>

              <!-- Informations produit -->
              <div class="ligne-info">
                <h3 class="produit-nom">{{ ligne.nomProduit }}</h3>

                <div class="ligne-details">
                  <div class="detail-item">
                    <i class="fas fa-calendar"></i>
                    <span>{{ ligne.dateDebut }} → {{ ligne.dateFin }}</span>
                  </div>

                  <div class="detail-item">
                    <i class="fas fa-clock"></i>
                    <span>{{ ligne.nbJours }} jour{{ ligne.nbJours > 1 ? 's' : '' }}</span>
                  </div>

                  <div class="detail-item">
                    <i class="fas fa-tag"></i>
                    <span>{{ ligne.prixUnitaire | number:'1.2-2' }} TND / jour</span>
                  </div>
                </div>

                <!-- ✅ Message d'alerte pour stock limité -->
                @if (getDisponibiliteLigne(ligne); as dispo) {
                  @if (dispo.disponible && dispo.quantiteMax <= 5 && dispo.quantiteMax > 0) {
                    <div class="alerte-stock">
                      <i class="fas fa-exclamation-circle"></i>
                      Plus que {{ dispo.quantiteMax }} disponible(s) pour cette période
                    </div>
                  }
                  @if (!dispo.disponible) {
                    <div class="alerte-indisponible">
                      <i class="fas fa-times-circle"></i>
                      Ce produit n'est plus disponible pour cette période
                    </div>
                  }
                }

                <!-- Contrôle de quantité -->
                <div class="quantite-control">
                  <label>Quantité :</label>

                  <div class="quantite-buttons">
                    <!-- ✅ FIX #8: Bouton décrémenter fonctionnel -->
                    <button
                      class="btn-quantite"
                      (click)="decrementerQuantite(ligne)"
                      [disabled]="ligne.quantite <= 1"
                      title="Diminuer la quantité"
                    >
                      <i class="fas fa-minus"></i>
                    </button>

                    <!-- ✅ Remplacer le <span> par ceci -->
                    <input
                      type="number"
                      class="quantite-input"
                      [value]="ligne.quantite"
                      (input)="onQuantiteInputChange(ligne, $event)"
                      (blur)="validerQuantite(ligne, $event)"
                      [min]="1"
                      [max]="getQuantiteMax(ligne)"
                      title="Saisir la quantité"
                    />

                    <!-- ✅ FIX #8 & #9: Bouton incrémenter fonctionnel et désactivé à la limite -->
                    <button
                      class="btn-quantite"
                      (click)="incrementerQuantite(ligne)"
                      [disabled]="estQuantiteMaximale(ligne)"
                      [title]="estQuantiteMaximale(ligne) ? 'Quantité maximale atteinte' : 'Augmenter la quantité'"
                    >
                      <i class="fas fa-plus"></i>
                    </button>
                  </div>

                  <!-- Prix de la ligne -->
                  <div class="ligne-prix">
                    <span class="sous-total-label">Sous-total :</span>
                    <span class="sous-total-montant">
                      {{ ligne.sousTotal | number:'1.2-2' }} TND
                    </span>
                  </div>
                </div>

                <!-- Observations (optionnel) -->
                <div class="ligne-observations">
                  <label for="obs-{{ ligne.idProduit }}">
                    <i class="fas fa-comment"></i>
                    Observations (optionnel)
                  </label>
                  <textarea
                    [id]="'obs-' + ligne.idProduit"
                    [(ngModel)]="ligne.observations"
                    (ngModelChange)="modifierObservationsLigne(ligne, $event)"
                    placeholder="Ajoutez des précisions..."
                    rows="2"
                    class="observations-input"
                  ></textarea>
                </div>

                <!-- Bouton supprimer -->
                <button
                  class="btn-supprimer-ligne"
                  (click)="retirerLigne(ligne)"
                  title="Retirer du panier"
                >
                  <i class="fas fa-trash-alt"></i>
                  Retirer
                </button>
              </div>
            </div>
          }
        </div>
      </div>

      <!-- Colonne droite : Résumé et validation -->
      <div class="panier-resume">
        <div class="resume-card">
          <h2>
            <i class="fas fa-calculator"></i>
            Résumé de la commande
          </h2>

          <div class="resume-details">
            <div class="resume-ligne">
              <span>Nombre d'articles :</span>
              <strong>{{ totalArticles() }}</strong>
            </div>

            <div class="resume-ligne">
              <span>Nombre de produits :</span>
              <strong>{{ nombreProduits() }}</strong>
            </div>

            <div class="resume-separateur"></div>

            <div class="resume-total">
              <span>Montant total :</span>
              <strong class="montant-total">{{ montantTotal() | number:'1.2-2' }} TND</strong>
            </div>
          </div>

          <!-- Observations générales -->
          <div class="observations-generales">
            <label for="observations">
              <i class="fas fa-comment-dots"></i>
              Observations pour l'agence (optionnel)
            </label>
            <textarea
              id="observations"
              [(ngModel)]="observations"
              (ngModelChange)="sauvegarderObservations()"
              placeholder="Ajoutez des informations supplémentaires..."
              rows="4"
              class="observations-textarea"
            ></textarea>
          </div>

          <!-- Actions de validation -->
          <div class="actions-validation">
            <!-- ✅ NOUVEAU BOUTON: Commander directement (noir) -->
            <button
              class="btn-commander-direct"
              (click)="commanderDirectement()"
              [disabled]="estVide() || isCreatingCommande()"
              title="Commander sans validation admin"
            >
              @if (isCreatingCommande()) {
                <i class="fas fa-spinner fa-spin"></i>
                Création en cours...
              } @else {
                <i class="fas fa-tag"></i>
               Passer Une Commande
              }
            </button>

            <button
              class="btn-valider"
              (click)="demanderDevis()"
              [disabled]="isCreatingDevis() || estVide()"
            >
              @if (isCreatingDevis()) {
                <i class="fas fa-spinner fa-spin"></i>
                Envoi en cours...
              } @else {
                <i class="fas fa-file-invoice"></i>
                Demander un devis
              }
            </button>

            <p class="info-validation">
              <i class="fas fa-info-circle"></i>
              Un administrateur validera votre demande de devis
            </p>
          </div>
        </div>
      </div>
    </div>
  }
</div>
